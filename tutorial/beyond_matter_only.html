<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>7. Beyond matter-only simulations &mdash; CONCEPT Documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="canonical" href="https://jmd-dk.github.io/concept/tutorial/beyond_matter_only.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8. Bispectra and 2LPT" href="bispectra.html" />
    <link rel="prev" title="6. Working on remote clusters" href="working_remotely.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CO<em>N</em>CEPT
              <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">1. Effortless installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="first_simulations.html">2. Your first simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameter_files.html">3. Working with parameter files</a></li>
<li class="toctree-l2"><a class="reference internal" href="gravity.html">4. Mastering gravity</a><ul>
<li class="toctree-l3"><a class="reference internal" href="gravity.html#the-pm-method">4.1. The PM method</a></li>
<li class="toctree-l3"><a class="reference internal" href="gravity.html#the-p3m-method">4.2. The P¬≥M method</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_types.html">5. Other kinds of output</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_types.html#bispectra">5.1. Bispectra</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_types.html#d-renders">5.2. 3D renders</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_types.html#id1">5.3. 2D renders</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_types.html#snapshots">5.4. Snapshots</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="working_remotely.html">6. Working on remote clusters</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">7. Beyond matter-only simulations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#radiation">7.1. Radiation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#massive-neutrinos">7.2. Massive neutrinos</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dynamical-dark-energy">7.3. Dynamical dark energy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#decaying-cold-dark-matter">7.4. Decaying cold dark matter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#non-linear-massive-neutrinos">7.5. Non-linear massive neutrinos</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="bispectra.html">8. Bispectra and 2LPT</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget.html">9. Comparison with GADGET-2</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#supported-platforms">Supported platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#standard-installation">Standard installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#optimal-network-performance-on-clusters">Optimal network performance on clusters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#cloning-with-git">Cloning with Git</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#the-install-script-in-depth">The <code class="docutils literal notranslate"><span class="pre">install</span></code> script in-depth</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#programs-installed">Programs installed</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#command-line-options">Command-line options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#influential-environment-variables">Influential environment variables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#making-use-of-pre-installed-libraries">Making use of pre-installed libraries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#specifying-dependency-versions">Specifying dependency versions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#specifying-dependency-urls">Specifying dependency URLs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#choosing-compiler-precedence">Choosing compiler precedence</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#installing-mpich-or-openmpi">Installing MPICH or OpenMPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#parallel-builds">Parallel builds</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#using-the-install-script-to-install-specific-libraries-but-not-concept-itself">Using the <code class="docutils literal notranslate"><span class="pre">install</span></code> script to install specific libraries but not CO<em>N</em>CEPT itself</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#dependencies">Dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#python-dependencies">Python dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#other-primary-dependencies">Other primary dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#system-dependencies">System dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#the-path-and-env-files">The <code class="docutils literal notranslate"><span class="pre">.path</span></code> and <code class="docutils literal notranslate"><span class="pre">.env</span></code> files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#the-path-file">The <code class="docutils literal notranslate"><span class="pre">.path</span></code> file</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#the-env-file">The <code class="docutils literal notranslate"><span class="pre">.env</span></code> file</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#path-like-environment-variables"><code class="docutils literal notranslate"><span class="pre">PATH</span></code>-like environment variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#eliminating-interference-from-foreign-python-installations">Eliminating interference from foreign Python installations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#the-mpi-executor">The <code class="docutils literal notranslate"><span class="pre">mpi_executor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#the-make-jobs-environment-variable">The <code class="docutils literal notranslate"><span class="pre">make_jobs</span></code> environment variable</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../command_line_options.html">Command-line options</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../command_line_options.html#basics">Basics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#help-h-help">Help: <code class="docutils literal notranslate"><span class="pre">-h</span></code>, <code class="docutils literal notranslate"><span class="pre">--help</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#parameter-file-p-param">Parameter file: <code class="docutils literal notranslate"><span class="pre">-p</span></code>, <code class="docutils literal notranslate"><span class="pre">--param</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#command-line-parameters-c-command-line-params">Command-line parameters: <code class="docutils literal notranslate"><span class="pre">-c</span></code>, <code class="docutils literal notranslate"><span class="pre">--command-line-params</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#number-of-processes-n-nprocs">Number of processes: <code class="docutils literal notranslate"><span class="pre">-n</span></code>, <code class="docutils literal notranslate"><span class="pre">--nprocs</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../command_line_options.html#specifying-multiple-nodes">Specifying multiple nodes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#utility-u-utility">Utility: <code class="docutils literal notranslate"><span class="pre">-u</span></code>, <code class="docutils literal notranslate"><span class="pre">--utility</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../command_line_options.html#remote-job-submission">Remote job submission</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#submit-submit">Submit: <code class="docutils literal notranslate"><span class="pre">--submit</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#queue-q-queue">Queue: <code class="docutils literal notranslate"><span class="pre">-q</span></code>, <code class="docutils literal notranslate"><span class="pre">--queue</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#wall-time-w-walltime">Wall time: <code class="docutils literal notranslate"><span class="pre">-w</span></code>, <code class="docutils literal notranslate"><span class="pre">--walltime</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#memory-memory">Memory: <code class="docutils literal notranslate"><span class="pre">--memory</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#job-name-job-name">Job name: <code class="docutils literal notranslate"><span class="pre">--job-name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#job-directive-j-job-directive">Job directive: <code class="docutils literal notranslate"><span class="pre">-j</span></code>, <code class="docutils literal notranslate"><span class="pre">--job-directive</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#watch-watch">Watch: <code class="docutils literal notranslate"><span class="pre">--watch</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../command_line_options.html#building-and-running">Building and running</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#local-local">Local: <code class="docutils literal notranslate"><span class="pre">--local</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#pure-python-pure-python">Pure Python: <code class="docutils literal notranslate"><span class="pre">--pure-python</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#build-b-build">Build: <code class="docutils literal notranslate"><span class="pre">-b</span></code>, <code class="docutils literal notranslate"><span class="pre">--build</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#rebuild-rebuild">Rebuild: <code class="docutils literal notranslate"><span class="pre">--rebuild</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#optimizations-optimizations">Optimizations: <code class="docutils literal notranslate"><span class="pre">--optimizations</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#link-time-optimizations-linktime-optimizations">Link time optimizations: <code class="docutils literal notranslate"><span class="pre">--linktime-optimizations</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#native-optimizations-native-optimizations">Native optimizations: <code class="docutils literal notranslate"><span class="pre">--native-optimizations</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#safe-build-safe-build">Safe build: <code class="docutils literal notranslate"><span class="pre">--safe-build</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../command_line_options.html#specials">Specials</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#test-t-tests">Test: <code class="docutils literal notranslate"><span class="pre">-t</span></code>, <code class="docutils literal notranslate"><span class="pre">--tests</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#main-entry-point-m-main">Main entry point: <code class="docutils literal notranslate"><span class="pre">-m</span></code>, <code class="docutils literal notranslate"><span class="pre">--main</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#interactive-i-interactive">Interactive: <code class="docutils literal notranslate"><span class="pre">-i</span></code>, <code class="docutils literal notranslate"><span class="pre">--interactive</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#version-v-version">Version: <code class="docutils literal notranslate"><span class="pre">-v</span></code>, <code class="docutils literal notranslate"><span class="pre">--version</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../parameters/parameters.html">Parameters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../parameters/input_output.html">Input/output</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#initial-conditions"><code class="docutils literal notranslate"><span class="pre">initial_conditions</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#output-dirs"><code class="docutils literal notranslate"><span class="pre">output_dirs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#output-bases"><code class="docutils literal notranslate"><span class="pre">output_bases</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#output-times"><code class="docutils literal notranslate"><span class="pre">output_times</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#autosave-interval"><code class="docutils literal notranslate"><span class="pre">autosave_interval</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#snapshot-select"><code class="docutils literal notranslate"><span class="pre">snapshot_select</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#powerspec-select"><code class="docutils literal notranslate"><span class="pre">powerspec_select</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#bispec-select"><code class="docutils literal notranslate"><span class="pre">bispec_select</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#render2d-select"><code class="docutils literal notranslate"><span class="pre">render2D_select</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#render3d-select"><code class="docutils literal notranslate"><span class="pre">render3D_select</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#snapshot-type"><code class="docutils literal notranslate"><span class="pre">snapshot_type</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#gadget-snapshot-params"><code class="docutils literal notranslate"><span class="pre">gadget_snapshot_params</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#snapshot-wrap"><code class="docutils literal notranslate"><span class="pre">snapshot_wrap</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#select-particle-id"><code class="docutils literal notranslate"><span class="pre">select_particle_id</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#class-plot-perturbations"><code class="docutils literal notranslate"><span class="pre">class_plot_perturbations</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#class-extra-background"><code class="docutils literal notranslate"><span class="pre">class_extra_background</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#class-extra-perturbations"><code class="docutils literal notranslate"><span class="pre">class_extra_perturbations</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/numerics.html">Numerics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/numerics.html#boxsize"><code class="docutils literal notranslate"><span class="pre">boxsize</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/numerics.html#potential-options"><code class="docutils literal notranslate"><span class="pre">potential_options</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/numerics.html#shortrange-params"><code class="docutils literal notranslate"><span class="pre">shortrange_params</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/numerics.html#powerspec-options"><code class="docutils literal notranslate"><span class="pre">powerspec_options</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/numerics.html#bispec-options"><code class="docutils literal notranslate"><span class="pre">bispec_options</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/numerics.html#bispec-antialiasing"><code class="docutils literal notranslate"><span class="pre">bispec_antialiasing</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/numerics.html#class-dedicated-spectra"><code class="docutils literal notranslate"><span class="pre">class_dedicated_spectra</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/numerics.html#class-modes-per-decade"><code class="docutils literal notranslate"><span class="pre">class_modes_per_decade</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/cosmology.html">Cosmology</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/cosmology.html#h0"><code class="docutils literal notranslate"><span class="pre">H0</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/cosmology.html#b"><code class="docutils literal notranslate"><span class="pre">Œ©b</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/cosmology.html#cdm"><code class="docutils literal notranslate"><span class="pre">Œ©cdm</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/cosmology.html#a-begin"><code class="docutils literal notranslate"><span class="pre">a_begin</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/cosmology.html#t-begin"><code class="docutils literal notranslate"><span class="pre">t_begin</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/cosmology.html#primordial-spectrum"><code class="docutils literal notranslate"><span class="pre">primordial_spectrum</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/cosmology.html#class-params"><code class="docutils literal notranslate"><span class="pre">class_params</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/cosmology.html#enable-class-background"><code class="docutils literal notranslate"><span class="pre">enable_class_background</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/physics.html">Physics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/physics.html#select-forces"><code class="docutils literal notranslate"><span class="pre">select_forces</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/physics.html#select-species"><code class="docutils literal notranslate"><span class="pre">select_species</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/physics.html#realization-options"><code class="docutils literal notranslate"><span class="pre">realization_options</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/physics.html#select-lives"><code class="docutils literal notranslate"><span class="pre">select_lives</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/physics.html#softening-kernel"><code class="docutils literal notranslate"><span class="pre">softening_kernel</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/physics.html#select-softening-length"><code class="docutils literal notranslate"><span class="pre">select_softening_length</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/simulation.html">Simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#t-base-background-factor"><code class="docutils literal notranslate"><span class="pre">Œît_base_background_factor</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#t-base-nonlinear-factor"><code class="docutils literal notranslate"><span class="pre">Œît_base_nonlinear_factor</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#t-increase-max-factor"><code class="docutils literal notranslate"><span class="pre">Œît_increase_max_factor</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#t-rung-factor"><code class="docutils literal notranslate"><span class="pre">Œît_rung_factor</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#a-max-early"><code class="docutils literal notranslate"><span class="pre">Œîa_max_early</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#a-max-late"><code class="docutils literal notranslate"><span class="pre">Œîa_max_late</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#static-timestepping"><code class="docutils literal notranslate"><span class="pre">static_timestepping</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#n-rungs"><code class="docutils literal notranslate"><span class="pre">N_rungs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#fftw-wisdom-rigor"><code class="docutils literal notranslate"><span class="pre">fftw_wisdom_rigor</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#fftw-wisdom-reuse"><code class="docutils literal notranslate"><span class="pre">fftw_wisdom_reuse</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#fftw-wisdom-share"><code class="docutils literal notranslate"><span class="pre">fftw_wisdom_share</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#random-seeds"><code class="docutils literal notranslate"><span class="pre">random_seeds</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#primordial-noise-imprinting"><code class="docutils literal notranslate"><span class="pre">primordial_noise_imprinting</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#primordial-amplitude-fixed"><code class="docutils literal notranslate"><span class="pre">primordial_amplitude_fixed</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#primordial-phase-shift"><code class="docutils literal notranslate"><span class="pre">primordial_phase_shift</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#cell-centered"><code class="docutils literal notranslate"><span class="pre">cell_centered</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#class-k-max"><code class="docutils literal notranslate"><span class="pre">class_k_max</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation.html#class-reuse"><code class="docutils literal notranslate"><span class="pre">class_reuse</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/graphics.html">Graphics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/graphics.html#terminal-width"><code class="docutils literal notranslate"><span class="pre">terminal_width</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/graphics.html#enable-terminal-formatting"><code class="docutils literal notranslate"><span class="pre">enable_terminal_formatting</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/graphics.html#render2d-options"><code class="docutils literal notranslate"><span class="pre">render2D_options</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/graphics.html#render3d-options"><code class="docutils literal notranslate"><span class="pre">render3D_options</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/units.html">Units</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/units.html#unit-length"><code class="docutils literal notranslate"><span class="pre">unit_length</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/units.html#unit-time"><code class="docutils literal notranslate"><span class="pre">unit_time</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/units.html#unit-mass"><code class="docutils literal notranslate"><span class="pre">unit_mass</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/debugging.html">Debugging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/debugging.html#print-load-imbalance"><code class="docutils literal notranslate"><span class="pre">print_load_imbalance</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/debugging.html#particle-reordering"><code class="docutils literal notranslate"><span class="pre">particle_reordering</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/debugging.html#enable-hubble"><code class="docutils literal notranslate"><span class="pre">enable_Hubble</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../utilities/utilities.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../utilities/class.html">class utility</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../utilities/class.html#basic-usage">Basic usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../utilities/class.html#command-line-options">Command-line options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../utilities/class.html#help-h-help">Help: <code class="docutils literal notranslate"><span class="pre">-h</span></code>, <code class="docutils literal notranslate"><span class="pre">--help</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../utilities/class.html#minimum-fourier-mode-kmin">Minimum Fourier mode: <code class="docutils literal notranslate"><span class="pre">--kmin</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../utilities/class.html#maximum-fourier-mode-kmax">Maximum Fourier mode: <code class="docutils literal notranslate"><span class="pre">--kmax</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../utilities/class.html#fourier-modes-modes">Fourier modes: <code class="docutils literal notranslate"><span class="pre">--modes</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../utilities/class.html#times-times">Times: <code class="docutils literal notranslate"><span class="pre">--times</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../utilities/class.html#gauge-gauge">Gauge: <code class="docutils literal notranslate"><span class="pre">--gauge</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../utilities/class.html#file-contents">File contents</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../utilities/class.html#data-layout">Data layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../utilities/class.html#extra-output">Extra output</a></li>
<li class="toctree-l4"><a class="reference internal" href="../utilities/class.html#units">Units</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../utilities/class.html#complete-example-massive-neutrinos">Complete example (massive neutrinos)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../utilities/class.html#running-through-docker">Running through Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../utilities/class.html#tips-and-tricks">Tips and tricks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/convert.html">convert utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/gadget.html">gadget utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/info.html">info utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/play.html">play utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/powerspec.html">powerspec utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/bispec.html">bispec utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/render3D.html">render3D utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/update.html">update utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/watch.html">watch utility</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#installation-failed">Installation failed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#compilation-failed">Compilation failed</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#insufficient-memory">Insufficient memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#dangerous-optimizations">Dangerous optimizations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#terminal-colour-output-looks-weird">Terminal colour output looks weird</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#problems-related-to-python-libraries-and-packages">Problems related to Python libraries and packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#error-messages-containing-read-1">Error messages containing ‚ÄòRead -1‚Äô</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#clock-skew-and-or-modification-times-in-the-future">Clock skew and/or modification times in the future</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#mixed-compiled-and-pure-python-mode">Mixed compiled and pure Python mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#the-simulation-hangs-when-calling-class">The simulation hangs when calling CLASS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#crashes-or-other-bad-behaviour">Crashes or other bad behaviour</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#problems-when-running-remotely">Problems when running remotely</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#choosing-an-mpi-executor">Choosing an MPI executor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#different-hardware-architecture-on-front-end-and-remote-node">Different hardware architecture on front-end and remote node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#it-still-does-not-work">It <em>still</em> does not work!</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#bad-performance-when-using-multiple-processes-nodes">Bad performance when using multiple processes/nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#problems-when-using-multiple-nodes">Problems when using multiple nodes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../publications.html#theses">Theses</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CO<em>N</em>CEPT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="tutorial.html">Tutorial</a></li>
      <li class="breadcrumb-item active"><span class="section-number">7. </span>Beyond matter-only simulations</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/jmd-dk/concept/" class="fa fa-github"> Code Repository</a>
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="working_remotely.html" class="btn btn-neutral float-left" title="6. Working on remote clusters" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="bispectra.html" class="btn btn-neutral float-right" title="8. Bispectra and 2LPT" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="beyond-matter-only-simulations">
<h1><span class="section-number">7. </span>Beyond matter-only simulations<a class="headerlink" href="#beyond-matter-only-simulations" title="Permalink to this heading">ÔÉÅ</a></h1>
<p>If you‚Äôve followed this tutorial so far, you‚Äôre now fully capable of using
CO<em>N</em>CEPT for running matter-only simulations. More exotic simulations ‚Äî
taking additional species into account ‚Äî are also possible, as this section
will demonstrate.</p>
<p>To assess the effects resulting from including non-matter species, we shall
perform a slew of simulations throughout this section. As most effects are
small, we shall also learn how to improve the precision in different
circumstances, introducing several new parameters. If you have no interest in
any of this, feel free to skip this section, as it‚Äôs rather lengthy and more
technical than the previous sections of this tutorial.</p>
<p>Each subsection below tackles a separate species/subject. Though you might be
interested in only one of these, it‚Äôs highly recommended to go through them
in order, as they build upon each other. Though each subsection deals with
a particular species in isolation, these may be mixed and matched at will when
running simulations.</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#radiation" id="id5">Radiation</a></p></li>
<li><p><a class="reference internal" href="#massive-neutrinos" id="id6">Massive neutrinos</a></p></li>
<li><p><a class="reference internal" href="#dynamical-dark-energy" id="id7">Dynamical dark energy</a></p></li>
<li><p><a class="reference internal" href="#decaying-cold-dark-matter" id="id8">Decaying cold dark matter</a></p></li>
<li><p><a class="reference internal" href="#non-linear-massive-neutrinos" id="id9">Non-linear massive neutrinos</a></p></li>
</ul>
</nav>
<section id="radiation">
<span id="id1"></span><h2><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">7.1. </span>Radiation</a><a class="headerlink" href="#radiation" title="Permalink to this heading">ÔÉÅ</a></h2>
<h3>Introduction</h3><p>Though universes of interest may contain several different species, in
cosmological <em>N</em>-body simulations we are typically interested in following the
evolution of the matter component only, as this is the only component which is
non-linear at cosmological scales. Even so, we may wish to not neglect the
small gravitational effects on matter from the other, linear species. We can
do this by solving the given cosmology (including the matter) in linear
perturbation theory ahead of time, and then feed the linear gravitational
field from all species but matter to the <em>N</em>-body simulation, applying the
otherwise missing gravity as an external force.</p>
<p>CO<em>N</em>CEPT uses the <a class="reference external" href="http://class-code.net/">CLASS</a> code to solve the
equations of linear perturbation theory. For details on how the linear
perturbations are applied to the <em>N</em>-body particles during the simulation, we
refer to the paper on
‚Äò<a class="reference internal" href="../publications.html#fully-relativistic-treatment-of-light-neutrinos-in-nbody-simulations"><span class="std std-ref">Fully relativistic treatment of light neutrinos in ùòï-body simulations</span></a>‚Äô.</p>
<p>We begin our exploration by performing a standard matter-only simulation, as
specified by the below parameter file:</p>
<div class="literal-block-wrapper docutils container" id="param-radiation">
<div class="code-block-caption"><span class="caption-text">param/tutorial-7.1 <span class="math notranslate nohighlight">\(\,\)</span> (radiation)</span><a class="headerlink" href="#param-radiation" title="Permalink to this code">ÔÉÅ</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Non-parameter helper variable used to control the size of the simulation</span>
<span class="n">_size</span> <span class="o">=</span> <span class="mi">192</span>

<span class="c1"># Input/output</span>
<span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Non-linear matter particles</span>
    <span class="p">{</span>
        <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;matter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;N&#39;</span>      <span class="p">:</span> <span class="n">_size</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span><span class="hll"><span class="k">for</span> <span class="n">_species</span> <span class="ow">in</span> <span class="n">_lin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span></span><span class="hll">    <span class="k">if</span> <span class="ow">not</span> <span class="n">_species</span><span class="p">:</span></span><span class="hll">        <span class="k">continue</span></span><span class="hll">    <span class="n">initial_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span></span><span class="hll">        <span class="c1"># Linear fluid component(s)</span></span><span class="hll">        <span class="p">{</span></span><span class="hll">            <span class="s1">&#39;species&#39;</span>        <span class="p">:</span> <span class="n">_species</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;gridsize&#39;</span>       <span class="p">:</span> <span class="n">_size</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;boltzmann order&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span></span><span class="hll">        <span class="p">}</span></span><span class="hll">    <span class="p">)</span></span><span class="n">output_dirs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">output_bases</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;powerspec</span><span class="si">{</span><span class="n">_lin</span><span class="si">=}</span><span class="s1">&#39;</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">output_times</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">a_begin</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Numerics</span>
<span class="n">boxsize</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">Gpc</span><span class="hll"><span class="n">potential_options</span> <span class="o">=</span> <span class="p">{</span></span><span class="hll">    <span class="s1">&#39;gridsize&#39;</span><span class="p">:</span> <span class="p">{</span></span><span class="hll">        <span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="p">{</span></span><span class="hll">            <span class="s1">&#39;pm&#39;</span> <span class="p">:</span>   <span class="n">_size</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;p3m&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">_size</span><span class="p">,</span></span><span class="hll">        <span class="p">},</span></span><span class="hll">    <span class="p">},</span></span><span class="hll"><span class="p">}</span></span>
<span class="c1"># Cosmology</span>
<span class="n">H0</span>      <span class="o">=</span> <span class="mi">67</span><span class="o">*</span><span class="n">km</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">Mpc</span><span class="p">)</span>
<span class="n">Œ©b</span>      <span class="o">=</span> <span class="mf">0.049</span>
<span class="n">Œ©cdm</span>    <span class="o">=</span> <span class="mf">0.27</span>
<span class="n">a_begin</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="c1"># Non-parameter helper variable used to specify linear components.</span>
<span class="c1"># Should be supplied as a command-line parameter.</span><span class="hll"><span class="n">_lin</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></span></pre></div>
</div>
</div>
<p>As usual, save the parameters as e.g. <code class="docutils literal notranslate"><span class="pre">param/tutorial-7.1</span></code>, then run the
simulation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span>-p<span class="w"> </span>param/tutorial-7.1
</pre></div>
</div>
<p>possibly with the addition of <code class="docutils literal notranslate"><span class="pre">-n</span> <span class="pre">4</span></code> or some other number of processes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The remainder of this section of the tutorial leaves out explicit mention
of the <code class="docutils literal notranslate"><span class="pre">-n</span></code> option to <code class="docutils literal notranslate"><span class="pre">concept</span></code> invocations. Please add whatever number
of processes you would like yourself. To always use e.g. 4 processes,
you may set the <code class="docutils literal notranslate"><span class="pre">CONCEPT_nprocs</span></code>
<a class="reference internal" href="../command_line_options.html#number-of-processes"><span class="std std-ref">environment variable</span></a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">CONCEPT_nprocs</span><span class="o">=</span><span class="m">4</span>
</pre></div>
</div>
</div>
<p>A relatively large number of particles <span class="math notranslate nohighlight">\(N = 192^3\)</span> is used in order to
increase the precision of the simulation. Our goal is to investigate the
effects from radiation perturbations, which are most pronounced at very large
scales and early times ‚Äî hence the large <code class="docutils literal notranslate"><span class="pre">boxsize</span></code> and early output time.
The unfamiliar parameter specifications will be explained in due time.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Do not fret if <a class="reference internal" href="#param-radiation"><span class="std std-ref">the above parameter file</span></a> ‚Äî and
those to come further down in this section ‚Äî looks complicated. They
<em>are</em> more complicated than normal parameter files, because here a single
parameter file is designed to be used for several different simulations,
necessitating parameter definitions being dependent on various flags.</p>
</div>
<h3>The hunt for high precision</h3><p>Investigating the resulting <code class="docutils literal notranslate"><span class="pre">output/tutorial-7.1/powerspec_lin=_a=0.02.png</span></code>
you should see a familiar looking simulation power spectrum: decently looking
at intermediary <span class="math notranslate nohighlight">\(k\)</span>, inaccurate at small <span class="math notranslate nohighlight">\(k\)</span> and with obvious
numerical artefacts at large <span class="math notranslate nohighlight">\(k\)</span>. As we are interested in fine details
at low <span class="math notranslate nohighlight">\(k\)</span>, we need to improve the precision here. We can do so by
adding</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">primordial_amplitude_fixed</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>to the parameter file and rerunning the simulation. This has the effect of
replacing the uncorrelated random amplitudes of the primordial noise used to
generate the initial conditions with amplitudes that are all of the same size.
With this change, <code class="docutils literal notranslate"><span class="pre">powerspec_lin=_a=0.02.png</span></code> should look much better at
low <span class="math notranslate nohighlight">\(k\)</span> (larger <span class="math notranslate nohighlight">\(k\)</span> are not very affected by this, as here many
more <span class="math notranslate nohighlight">\(\boldsymbol{k}\)</span> with the same magnitude <span class="math notranslate nohighlight">\(|\boldsymbol{k}|=k\)</span>
goes into producing each data point (recorded in the <code class="docutils literal notranslate"><span class="pre">modes</span></code> column in the
power spectrum data file), reducing errors arising due to small
number statistics).</p>
<p>We expect the evolution of the <em>N</em>-body particles to be completely linear at
these large scales and early times, and so we may use the difference between
the simulation and linear power spectrum as a measure for the error in the
simulation. To better see this difference, we shall make use of the below
plotting script:</p>
<div class="literal-block-wrapper docutils container" id="plot-radiation">
<div class="code-block-caption"><span class="caption-text">output/tutorial-7.1/plot.py <span class="math notranslate nohighlight">\(\,\)</span> (radiation)</span><a class="headerlink" href="#plot-radiation" title="Permalink to this code">ÔÉÅ</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span><span class="p">;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Read in data</span>
<span class="n">this_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">ks</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">P_sims</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">P_cors</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">P_lins</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/powerspec*&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">):</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?=_(.*?)=(.*?)_)&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> = &quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
    <span class="n">P_cor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">P_sim</span><span class="p">,</span> <span class="n">P_cor</span><span class="p">,</span> <span class="n">P_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">P_sim</span><span class="p">,</span> <span class="n">P_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">P_lin</span><span class="p">)</span>
    <span class="n">ks</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">P_lins</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">P_lin</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">P_cor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">P_cors</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">lin</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_cor</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">P_sims</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">lin</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_sim</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">darken</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.65</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ColorConverter</span><span class="p">()</span><span class="o">.</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">color</span><span class="p">))</span>
<span class="n">linestyles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">((</span><span class="n">lenk</span><span class="p">,</span> <span class="n">lin</span><span class="p">),</span> <span class="n">P_sim</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">P_sims</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyles</span><span class="p">[</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()[:</span><span class="mi">30</span><span class="p">],</span> <span class="n">P_sim</span><span class="p">[:</span><span class="mi">30</span><span class="p">],</span> <span class="mf">1e-3</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">linestyles</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">ks</span><span class="p">[</span><span class="n">lenk</span><span class="p">]</span>
    <span class="n">P_lin</span> <span class="o">=</span> <span class="n">P_lins</span><span class="p">[</span><span class="n">lenk</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P_sim</span><span class="p">,</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;simulation: </span><span class="si">{</span><span class="n">lin</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">P_sim</span><span class="o">/</span><span class="n">P_lin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">P_cor</span> <span class="o">=</span> <span class="n">P_cors</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">lenk</span><span class="p">,</span> <span class="n">lin</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">P_cor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">P_cor</span><span class="o">/</span><span class="n">P_lin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">darken</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">lenk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">ks</span><span class="p">[</span><span class="n">lenk</span><span class="p">]</span>
<span class="n">P_lin</span> <span class="o">=</span> <span class="n">P_lins</span><span class="p">[</span><span class="n">lenk</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P_lin</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">P_lin</span><span class="o">/</span><span class="n">P_lin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">k_max</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k_max</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.95</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">P_lin</span><span class="p">[</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">k_max</span><span class="p">]),</span> <span class="mf">1.05</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">P_lin</span><span class="p">[</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">k_max</span><span class="p">]))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">if</span> <span class="n">P_cors</span><span class="p">:</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">darken</span><span class="p">(</span><span class="s1">&#39;grey&#39;</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;corrected&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k\, [\mathrm</span><span class="si">{Mpc}</span><span class="s1">^{-1}]$&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$P\, [\mathrm</span><span class="si">{Mpc}</span><span class="s1">^3]$&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$P_{\mathrm</span><span class="si">{simulation}</span><span class="s1">}/P_{\mathrm</span><span class="si">{linear}</span><span class="s1">} - 1\, [\%]$&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;inout&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/plot.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Save the script as e.g. <code class="docutils literal notranslate"><span class="pre">output/tutorial-7.1/plot.py</span></code> and run it using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span>-m<span class="w"> </span>output/tutorial-7.1/plot.py
</pre></div>
</div>
<p>This will produce <code class="docutils literal notranslate"><span class="pre">output/tutorial-7.1/plot.png</span></code>, where the bottom panel
shows the relative error between the simulated power spectrum and that
computed using purely linear theory. They should agree to within a percent at
the lowest <span class="math notranslate nohighlight">\(k\)</span>. At higher <span class="math notranslate nohighlight">\(k\)</span> the agreement is worse. Though this
can be remedied by increasing the resolution of the simulation (e.g. by
increasing <code class="docutils literal notranslate"><span class="pre">_size</span></code>), we shall not do so here, as we focus on the lower
<span class="math notranslate nohighlight">\(k\)</span> only.</p>
<p>The power spectra outputted by the simulation are binned logarithmically in
<span class="math notranslate nohighlight">\(k\)</span>. This is usually desirable, though higher precision at the lowest
<span class="math notranslate nohighlight">\(k\)</span> can be achieved by leaving out this binning. The number of bins per
decade ‚Äî among many other specifics ‚Äî is controlled through the
<code class="docutils literal notranslate"><span class="pre">powerspec_options</span></code> parameter. Disabling the binning can be achieved by
requesting an infinite number of bins per decade. Add</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">powerspec_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;bins per decade&#39;</span><span class="p">:</span> <span class="n">inf</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>to the parameter file, then rerun the simulation and the plotting script.
Though the simulation power spectrum generally becomes more jagged, you should
observe better agreement with linear theory at low <span class="math notranslate nohighlight">\(k\)</span>.</p>
<h3>Including linear species</h3><p>With our high-precision setup established, we are ready to start experimenting
with adding in the missing species to the simulation, hopefully leading to
better agreement with linear theory on the largest scales. To keep the clutter
within <code class="docutils literal notranslate"><span class="pre">output/tutorial-7.1</span></code> to a minimum, go ahead and add</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">powerspec_select</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>to the parameter file before continuing.</p>
<p>The inhomogeneities in the CMB causes a slight gravitational tug on matter,
perturbing its evolution. To add this effect to the simulation, we need to add
a photon component. This could look like (do not change the parameter file)</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Non-linear matter particles</span>
    <span class="p">{</span>
        <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;matter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;N&#39;</span>      <span class="p">:</span> <span class="n">_size</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="c1"># Linear photon fluid</span>
    <span class="p">{</span>
        <span class="s1">&#39;species&#39;</span>        <span class="p">:</span> <span class="s1">&#39;photon&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gridsize&#39;</span>       <span class="p">:</span> <span class="n">_size</span><span class="p">,</span>
        <span class="s1">&#39;boltzmann order&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
<p>We do not want to model the photons using <em>N</em>-body particles, but rather as a
collection of spatially fixed grids, storing the energy density, momentum
density, etc. This is referred to as the <em>fluid representation</em> ‚Äî as opposed
to the <em>particle representation</em> ‚Äî and is generally preferable for
linear components. To represent the photon component as a fluid, we specify
<code class="docutils literal notranslate"><span class="pre">'gridsize'</span></code> in place of <code class="docutils literal notranslate"><span class="pre">'N'</span></code>, where <code class="docutils literal notranslate"><span class="pre">'gridsize'</span></code> is the number of grid
cells along each dimension, for the cubic fluid grids. Finally, the number of
fluid quantities ‚Äî and corresponding grids ‚Äî to take into account is
implicitly specified by the <em>Boltzmann order</em>. As is
<a class="reference external" href="https://arxiv.org/abs/astro-ph/9506072">customary</a> in linear perturbation
theory, we transform the Boltzmann equation for a given species into an
infinite hierarchy of multipole moments <span class="math notranslate nohighlight">\(\ell \geq 0\)</span>. We then partition
this hierarchy in two; a non-linear part <span class="math notranslate nohighlight">\(\ell \leq \ell_{\text{nl}}\)</span>
and a linear part <span class="math notranslate nohighlight">\(\ell &gt; \ell_{\text{nl}}\)</span>, where
<span class="math notranslate nohighlight">\(\ell_{\text{nl}}\)</span> is precisely the Boltzmann order. A few examples
shall illuminate this concept:</p>
<ul class="simple">
<li><p><strong>Boltzmann order 0</strong>: The evolution equation for the lowest moment (i.e.
the continuity equation for the energy density) is solved non-linearly
during the simulation, while higher moments like momentum density (on which
the energy density depends) are solved in pure linear theory.</p></li>
<li><p><strong>Boltzmann order 1</strong>: The evolution equations for the two lowest moments
(i.e. the continuity equation for the energy density and the Euler equation
for the momentum density) are solved non-linearly during the simulation,
while higher moments like pressure and shear (on which the energy and
momentum density depends) are solved in pure linear theory.</p></li>
<li><p><strong>Boltzmann order -1</strong>: None of the moments are treated non-linearly, i.e.
this results in a purely linear component. Though the evolution of such a
component is independent of the simulation, a purely linear component may
still act with a force on other, non-linear components during
the simulation.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Though higher Boltzmann orders are well-defined, the largest Boltzmann
order currently implemented in CO<em>N</em>CEPT is <span class="math notranslate nohighlight">\(1\)</span>.</p>
</div>
<p>We shall look into Boltzmann order <span class="math notranslate nohighlight">\(+1\)</span> in the subsection on
<a class="reference internal" href="#nonlinear-massive-neutrinos"><span class="std std-ref">non-linear massive neutrinos</span></a>. For now we
shall keep to the purely linear case of Boltzmann order <span class="math notranslate nohighlight">\(-1\)</span>.</p>
<p>For fluid components (whether linear or not), the only sensible gravitational
method is that of PM. Looking at <a class="reference internal" href="#param-radiation"><span class="std std-ref">the parameter file</span></a>,
we see that a grid size of <code class="docutils literal notranslate"><span class="pre">_size</span></code> is specified for <code class="docutils literal notranslate"><span class="pre">'pm'</span></code>. This <em>must</em>
match the <em>fluid grid size</em>, i.e. the value specified for <code class="docutils literal notranslate"><span class="pre">'gridsize'</span></code> for
the fluid component in <code class="docutils literal notranslate"><span class="pre">initial_conditions</span></code>, so that the geometry of the
grid(s) internal to the fluid component matches that of the potential grid.
Now the simulation has <em>two</em> potential grids; one for P¬≥M self-gravity of
the matter particles (of grid size <code class="docutils literal notranslate"><span class="pre">2*_size</span></code>) and one for PM one-way gravity
from the linear photon fluid to the matter particles (of grid size <code class="docutils literal notranslate"><span class="pre">_size</span></code>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As the PM grid size has to match the fluid grid size, you do in fact not
need to specify the <code class="docutils literal notranslate"><span class="pre">'pm'</span></code> item of <code class="docutils literal notranslate"><span class="pre">potential_options</span></code> in
<a class="reference internal" href="#param-radiation"><span class="std std-ref">the parameter file</span></a>. You still need to have the
explicit specifications of <code class="docutils literal notranslate"><span class="pre">'gridsize'</span></code>, <code class="docutils literal notranslate"><span class="pre">'gravity'</span></code> and <code class="docutils literal notranslate"><span class="pre">'p3m'</span></code>,
though. Specifying simply <code class="docutils literal notranslate"><span class="pre">potential_options</span> <span class="pre">=</span> <span class="pre">2*_size</span></code> sets the P¬≥M
<em>and</em> PM grid size to <code class="docutils literal notranslate"><span class="pre">2*_size</span></code>, which fails for our fluid with grid
size <code class="docutils literal notranslate"><span class="pre">_size</span></code>.</p>
</div>
<p>The parameter file has already been set up to include optional linear fluid
components, using the <code class="docutils literal notranslate"><span class="pre">_lin</span></code> command-line parameter. To perform a simulation
with the inclusion of linear photons, run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;photon&#39;&quot;</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">_lin</span></code> helper variable is defined at the bottom of the
parameter file to have an empty value (leading to no linear species being
included). As this is placed after all actual parameters, this defines a
default value which is used when <code class="docutils literal notranslate"><span class="pre">_lin</span></code> is not given as a command-line
parameter. As <code class="docutils literal notranslate"><span class="pre">_size</span></code> is defined at the top, supplying <code class="docutils literal notranslate"><span class="pre">_size</span></code> as a
command-line parameter will have no effect.</p>
</div>
<p>Now redo the plot, and the results of both the matter-only and the matter +
photon simulation should appear. The plot will show that ‚Äî sadly ‚Äî
including the photons does <em>not</em> lead to better large-scale behaviour.</p>
<p>CO<em>N</em>CEPT delegates all linear (and background) computations to the
<a class="reference external" href="http://class-code.net/">CLASS</a> code. Though we have specified <span class="math notranslate nohighlight">\(H_0\)</span>,
<span class="math notranslate nohighlight">\(\Omega_{\text{b}}\)</span> and <span class="math notranslate nohighlight">\(\Omega_{\text{cdm}}\)</span> in the parameter file,
many cosmological parameters are still left unspecified. Here the default CLASS
parameters are used, which in addition to baryons, cold dark matter and photons
also contain massless neutrinos. With our hope renewed, let‚Äôs run a simulation
which includes both linear photons and linear massless neutrinos:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;photon, massless neutrino&#39;&quot;</span>
</pre></div>
</div>
<p>Redoing the plot, we discover that including the neutrinos made the
disagreement between the simulation and linear theory even larger!</p>
<p>The gravity applied to the non-linear matter particles from the linear photon
and neutrino fluids is the <em>Newtonian</em> gravity, i.e. that which results from
their energy densities. By contrast, the linear theory computation includes
full general relativistic gravity, meaning that we have still to account for
the gravitational effects due to the momentum density, pressure and shear of
the photons and neutrinos. As this part of gravity amounts to a general
relativistic correction, we shall refer to it as the <em>metric</em> contribution.
That is, we invent a new numerical species, the metric, containing the
collective non-Newtonian gravitational effects due to all physical species. As
demonstrated in the paper on
‚Äò<a class="reference internal" href="../publications.html#fully-relativistic-treatment-of-light-neutrinos-in-nbody-simulations"><span class="std std-ref">Fully relativistic treatment of light neutrinos in ùòï-body simulations</span></a>‚Äô,
this metric species might be numerically realised as a (fictitious) linear
energy density field, the <em>Newtonian</em> gravity from which implements exactly
the missing general relativistic corrections.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For the metric species to be able to supply the correct force, the entire
simulation must be performed in a particular gauge; the <em>N</em>-body gauge.
That is, initial conditions for non-linear species as well as linear input
during the simulation must all be in this gauge. This is the default gauge
employed by CO<em>N</em>CEPT, though
<a class="reference internal" href="../parameters/physics.html#realization-options"><span class="std std-ref">other gauges are available as well</span></a>. Note that
all outputs are similarly in this gauge, including non-linear
(CO<em>N</em>CEPT) and linear (CLASS) power spectra. Direct comparison to
output from other <em>N</em>-body codes (which often do not define a gauge at all)
is generally perfectly doable, as the choice of gauge only becomes aparrent
at very large scales.</p>
</div>
<p>To finally run a simulation which includes the gravitational effects from
photons and neutrinos in their entirety, run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;photon, massless neutrino, metric&#39;&quot;</span>
</pre></div>
</div>
<p>Re-plotting, you should see a much better behaved simulation power spectrum at
large scales, agreeing with linear theory to well within 0.1%.</p>
<h3>Combining species</h3><p>If you‚Äôve read along in the terminal output during the simulations, you may
have noticed that the energy density, <span class="math notranslate nohighlight">\(\varrho\)</span>, of each of the linear
species are realised in turn. We can save some time and memory by treating all
linear species as a single, collective component. To specify this, we would
normally write e.g.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Non-linear matter particles</span>
    <span class="p">{</span>
        <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;matter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;N&#39;</span>      <span class="p">:</span> <span class="n">_size</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="c1"># Linear fluid component</span>
    <span class="p">{</span>
        <span class="s1">&#39;species&#39;</span>        <span class="p">:</span> <span class="s1">&#39;photon + massless neutrino + metric&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gridsize&#39;</span>       <span class="p">:</span> <span class="n">_size</span><span class="p">,</span>
        <span class="s1">&#39;boltzmann order&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Using <a class="reference internal" href="#param-radiation"><span class="std std-ref">our clever parameter file</span></a> however, we may
specify this directly at the command-line using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;photon + massless neutrino + metric&#39;&quot;</span>
</pre></div>
</div>
<p>This idea of combining species is embraced fully by CO<em>N</em>CEPT. As such,
the species <code class="docutils literal notranslate"><span class="pre">'photon</span> <span class="pre">+</span> <span class="pre">massless</span> <span class="pre">neutrino'</span></code> may be collectively referred to
simply as <code class="docutils literal notranslate"><span class="pre">'radiation'</span></code>. Thus,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;radiation + metric&#39;&quot;</span>
</pre></div>
</div>
<p>works just as well. You are encouraged to run at least one of the above and
check that you obtain the same result as before.</p>
<p>You are in fact already familiar with the idea of combining species, as
<code class="docutils literal notranslate"><span class="pre">'matter'</span></code> really means <code class="docutils literal notranslate"><span class="pre">'baryon</span> <span class="pre">+</span> <span class="pre">cold</span> <span class="pre">dark</span> <span class="pre">matter'</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When performing simulations in a cosmology without massless neutrinos,
specifying <code class="docutils literal notranslate"><span class="pre">'photon</span> <span class="pre">+</span> <span class="pre">massless</span> <span class="pre">neutrino'</span></code> as the species of a component
will produce an error. However, specifying <code class="docutils literal notranslate"><span class="pre">'radiation'</span></code> is always safe,
as this dynamically maps to the set of all radiation species present in the
current cosmology, whatever this may be. Similarly, <code class="docutils literal notranslate"><span class="pre">'matter'</span></code> is safe to
use even in a cosmology without e.g. cold dark matter.</p>
</div>
<h3>Noise-corrected power spectra</h3><p>With confidence in the linear corrections, let us now go back to using binned
power spectra (the standard). That is, remove the <code class="docutils literal notranslate"><span class="pre">powerspec_options</span></code>
parameter ‚Äî which you introduced earlier ‚Äî from the parameter file.
Further add <em>corrected</em> non-linear power spectra to the desired output, by
changing <code class="docutils literal notranslate"><span class="pre">powerspec_select</span></code> to</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">powerspec_select</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;corrected&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>inside the parameter file. Now perform one last simulation, including the
necessary linear corrections;</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;radiation + metric&#39;&quot;</span>
</pre></div>
</div>
<p>After updating the plot yet again, you should find that you are able to obtain
excellent agreement with linear theory with the binned spectra as well, when
using the noise-corrected version of the power spectrum.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The corrected simulation power spectrum is obtained from the ‚Äúraw‚Äù
simulation power spectrum, with noise due to the binning as well as noise
due the current realization (cosmic variance) reduced.</p>
</div>
<p>To better disentangle the effects of the linear corrections from those of the
corrected power spectrum, you may further wish to rerun the simulation
with<em>out</em> any linear corrections, keeping the corrected power spectrum
output enabled.</p>
</section>
<section id="massive-neutrinos">
<span id="id2"></span><h2><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">7.2. </span>Massive neutrinos</a><a class="headerlink" href="#massive-neutrinos" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>The previous subsection demonstrated how simulations of matter can be made to
agree extremely well with linear theory at linear scales, if we include the
gravitational contributions from the otherwise missing species, which were
treated linearly. We did this by comparing the simulated power spectrum
directly to the linear one, for the same cosmology.</p>
<p>With confidence in the strategy of including linear species, let‚Äôs now look at
the relative difference in matter power between two separate cosmologies, with
and without the inclusion of linear species. As dividing one simulated power
spectrum by another cancels out much of the numerical noise, this time we can
obtain high accuracy without using any of the tricks from the previous
subsection.</p>
<p>Our aim shall be to compute the effect on the matter power spectrum caused by
neglecting the fact that neutrinos really do have mass, albeit small. If you
wish to study the underlying theory as well as the implementation in
CO<em>N</em>CEPT, we refer to the paper on
‚Äò<a class="reference internal" href="../publications.html#fully-relativistic-treatment-of-light-neutrinos-in-nbody-simulations"><span class="std std-ref">Fully relativistic treatment of light neutrinos in ùòï-body simulations</span></a>‚Äô.</p>
<h3>Adding massive neutrinos to the background cosmology</h3><p>To compute the effect on the matter power spectrum caused by neglecting the
fact that neutrinos do have some mass, we shall make use of the below
parameter file:</p>
<div class="literal-block-wrapper docutils container" id="param-massive-neutrinos">
<div class="code-block-caption"><span class="caption-text">param/tutorial-7.2 <span class="math notranslate nohighlight">\(\,\)</span> (massive neutrinos)</span><a class="headerlink" href="#param-massive-neutrinos" title="Permalink to this code">ÔÉÅ</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Non-parameter helper variable used to control the size of the simulation</span>
<span class="n">_size</span> <span class="o">=</span> <span class="mi">80</span>

<span class="c1"># Input/output</span>
<span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Non-linear matter particles</span>
    <span class="p">{</span>
        <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;matter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;N&#39;</span>      <span class="p">:</span> <span class="n">_size</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">_species</span> <span class="ow">in</span> <span class="n">_lin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_species</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">initial_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="c1"># Linear fluid component(s)</span>
        <span class="p">{</span>
            <span class="s1">&#39;species&#39;</span>        <span class="p">:</span> <span class="n">_species</span><span class="p">,</span>
            <span class="s1">&#39;gridsize&#39;</span>       <span class="p">:</span> <span class="n">_size</span><span class="p">,</span>
            <span class="s1">&#39;boltzmann order&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="n">output_dirs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">output_bases</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;powerspec</span><span class="si">{</span><span class="n">_mass</span><span class="si">=}{</span><span class="n">_lin</span><span class="si">=}</span><span class="s1">&#39;</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">output_times</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">powerspec_select</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
<span class="p">}</span>

<span class="c1"># Numerics</span>
<span class="n">boxsize</span> <span class="o">=</span> <span class="mf">1.4</span><span class="o">*</span><span class="n">Gpc</span>
<span class="n">potential_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;gridsize&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;p3m&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">_size</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1"># Cosmology</span>
<span class="n">H0</span>      <span class="o">=</span> <span class="mi">67</span><span class="o">*</span><span class="n">km</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">Mpc</span><span class="p">)</span>
<span class="n">Œ©b</span>      <span class="o">=</span> <span class="mf">0.049</span><span class="hll"><span class="n">Œ©cdm</span>    <span class="o">=</span> <span class="mf">0.27</span> <span class="o">-</span> <span class="n">Œ©ŒΩ</span></span><span class="n">a_begin</span> <span class="o">=</span> <span class="mf">0.01</span><span class="hll"><span class="n">class_params</span> <span class="o">=</span> <span class="p">{</span></span><span class="hll">    <span class="c1"># Disable massless neutrinos</span></span><span class="hll">    <span class="s1">&#39;N_ur&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span></span><span class="hll">    <span class="c1"># Add 3 massive neutrinos of equal mass</span></span><span class="hll">    <span class="s1">&#39;N_ncdm&#39;</span>  <span class="p">:</span> <span class="mi">1</span><span class="p">,</span></span><span class="hll">    <span class="s1">&#39;deg_ncdm&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span></span><span class="hll">    <span class="s1">&#39;m_ncdm&#39;</span>  <span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">_mass</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1e-100</span><span class="p">),</span>  <span class="c1"># avoid exact value of 0.0</span></span><span class="hll"><span class="p">}</span></span>
<span class="c1"># Non-parameter helper variables which should</span>
<span class="c1"># be supplied as command-line parameters.</span><span class="hll"><span class="n">_mass</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># sum of neutrino masses in eV</span></span><span class="n">_lin</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># linear species to include</span>
</pre></div>
</div>
</div>
<p>You may want to save this as e.g. <code class="docutils literal notranslate"><span class="pre">param/tutorial-7.2</span></code> and get a simulation
going ‚Äî of course using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span>-p<span class="w"> </span>param/tutorial-7.2
</pre></div>
</div>
<p>‚Äî while you read on.</p>
<p>The new elements appearing in the parameter file are:</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">class_params</span></code> <a class="reference internal" href="../parameters/cosmology.html#class-params"><span class="std std-ref">parameter</span></a> has been added. Items
defined within <code class="docutils literal notranslate"><span class="pre">class_params</span></code> are passed onto CLASS and are thus used for
the background and linear computations. That is, <code class="docutils literal notranslate"><span class="pre">class_params</span></code> is used to
change the cosmology deployed within the CO<em>N</em>CEPT simulation away from
the default cosmology as defined by CLASS.</p>
<p>As with CO<em>N</em>CEPT itself, a vast number of CLASS parameters exist. The
best source for exploring these is probably the
<a class="reference external" href="https://github.com/lesgourg/class_public/blob/v2.7.2/explanatory.ini">explanatory.ini</a>
example CLASS parameter file, which also lists default values.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>As <span class="math notranslate nohighlight">\(H_0\)</span> (<code class="docutils literal notranslate"><span class="pre">H0</span></code>), <span class="math notranslate nohighlight">\(\Omega_{\text{b}}\)</span> (<code class="docutils literal notranslate"><span class="pre">Œ©b</span></code>) and
<span class="math notranslate nohighlight">\(\Omega_{\text{cdm}}\)</span> (<code class="docutils literal notranslate"><span class="pre">Œ©cdm</span></code>) already exists as CO<em>N</em>CEPT
parameters, these should never be specified explicitly within
<code class="docutils literal notranslate"><span class="pre">class_params</span></code>.</p>
</div>
<p>Of interest to us now are <code class="docutils literal notranslate"><span class="pre">'N_ur'</span></code> and <code class="docutils literal notranslate"><span class="pre">'N_ncdm'</span></code>; the number of
<strong>u</strong>ltra-<strong>r</strong>elativistic species (massless neutrinos) and
<strong>n</strong>on-<strong>c</strong>old <strong>d</strong>ark <strong>m</strong>atter species (massive neutrinos).
In the above parameter specifications, we switch out the default use of
massless neutrinos with one (<code class="docutils literal notranslate"><span class="pre">'N_ncdm':</span> <span class="pre">1</span></code>) 3-times degenerate
(<code class="docutils literal notranslate"><span class="pre">'deg_ncdm':</span> <span class="pre">3</span></code>) massive neutrino, which really amounts to three separate
neutrinos but all of the same mass (<code class="docutils literal notranslate"><span class="pre">'m_ncdm'</span></code>).</p>
</li>
<li><p>Besides <code class="docutils literal notranslate"><span class="pre">_lin</span></code>, another command-line parameter <code class="docutils literal notranslate"><span class="pre">_mass</span></code> is now in play.
This is the sum of neutrino masses <span class="math notranslate nohighlight">\(\sum m_\nu\)</span>, in eV. As we have
three neutrinos of equal mass, the neutrino mass <code class="docutils literal notranslate"><span class="pre">'m_ncdm'</span></code> is set to
<code class="docutils literal notranslate"><span class="pre">_mass/3</span></code>.</p>
<p>We can in fact obtain massless neutrinos in CLASS using the ‚Äòncdm‚Äô species
by setting <code class="docutils literal notranslate"><span class="pre">'m_ncdm'</span></code> to zero. To avoid potential safeguards employed by
CLASS, we ensure that a specified value of exactly <code class="docutils literal notranslate"><span class="pre">0.0</span></code> gets replaced by
a tiny but non-zero number (here <span class="math notranslate nohighlight">\(10^{-100}\)</span>).</p>
</li>
<li><p>As you may gather from the name ‚Äònon-cold dark matter‚Äô, the massive
neutrinos behave like unrelativistic dark matter during most if not all of
the simulation time span (unless <code class="docutils literal notranslate"><span class="pre">_mass</span></code> is set very low). When specifying
the amount of dark matter in the cosmology, one may then choose to state
<span class="math notranslate nohighlight">\(\Omega_{\text{cdm}} + \Omega_\nu\)</span> instead of
<span class="math notranslate nohighlight">\(\Omega_{\text{cdm}}\)</span> alone. Since <span class="math notranslate nohighlight">\(\Omega_\nu\)</span> is implicitly
fixed by the choice of neutrino masses (and a few other parameters), this
means that <span class="math notranslate nohighlight">\(\Omega_{\text{cdm}}\)</span> can no longer be chosen freely.
Rather, if we want the total dark matter energy density parameter to equal
e.g. 0.27, <span class="math notranslate nohighlight">\(\Omega_{\text{cdm}} + \Omega_{\nu} = 0.27\)</span>, we must
specify <code class="docutils literal notranslate"><span class="pre">Œ©cdm</span> <span class="pre">=</span> <span class="pre">0.27</span> <span class="pre">-</span> <span class="pre">Œ©ŒΩ</span></code>, as is done in the
<a class="reference internal" href="#param-massive-neutrinos"><span class="std std-ref">above parameter file</span></a>. Just like <code class="docutils literal notranslate"><span class="pre">h</span></code> is
automatically inferred from <code class="docutils literal notranslate"><span class="pre">H0</span></code>, so is <code class="docutils literal notranslate"><span class="pre">Œ©ŒΩ</span></code> automatically inferred
from <code class="docutils literal notranslate"><span class="pre">class_params</span></code>. As this latter inference is non-trivial, the
resulting <code class="docutils literal notranslate"><span class="pre">Œ©ŒΩ</span></code> is written to the terminal at the beginning of the
simulation.</p></li>
</ul>
<p>Once the first simulation ‚Äî with a cosmology including three ‚Äúmassive‚Äù
neutrinos of zero mass ‚Äî is done, run a simulation with e.g.
<span class="math notranslate nohighlight">\(\sum m_\nu = 0.1\, \text{eV}\)</span>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-p<span class="w"> </span>param/tutorial-7.2<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-c<span class="w"> </span><span class="s2">&quot;_mass = 0.1&quot;</span>
</pre></div>
</div>
<p>With both simulations done, we can plot their relative power spectrum. To do
this, you should make use of the following script:</p>
<div class="literal-block-wrapper docutils container" id="plot-massive-neutrinos">
<div class="code-block-caption"><span class="caption-text">output/tutorial-7.2/plot.py <span class="math notranslate nohighlight">\(\,\)</span> (massive neutrinos)</span><a class="headerlink" href="#plot-massive-neutrinos" title="Permalink to this code">ÔÉÅ</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span><span class="p">;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Read in data</span>
<span class="n">this_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">P_sims</span><span class="p">,</span> <span class="n">P_lins</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/powerspec*&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">):</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?=_(.*?)=(.*?)_)&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> = &quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">P_sim</span><span class="p">,</span> <span class="n">P_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">P_lin</span><span class="p">)</span>
    <span class="n">P_sims</span><span class="p">[</span><span class="n">mass</span><span class="p">,</span> <span class="n">lin</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_sim</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">P_lins</span><span class="p">[</span><span class="n">mass</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">P_lin</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="k">for</span> <span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">lin</span><span class="p">),</span> <span class="n">P_sim</span> <span class="ow">in</span> <span class="n">P_sims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mass</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">mass_nonzero</span> <span class="o">=</span> <span class="n">mass</span>
    <span class="n">P_sim_ref</span> <span class="o">=</span> <span class="n">P_sims</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">lin</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">P_sim_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">P_sim</span><span class="o">/</span><span class="n">P_sim_ref</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;simulation: </span><span class="si">{</span><span class="n">mass</span><span class="w"> </span><span class="si">= }</span><span class="s1"> eV, </span><span class="si">{</span><span class="n">lin</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">P_lins</span><span class="p">[</span><span class="n">mass_nonzero</span><span class="p">]</span><span class="o">/</span><span class="n">P_lins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k\, [\mathrm</span><span class="si">{Mpc}</span><span class="s1">^{-1}]$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
    <span class="sa">rf</span><span class="s1">&#39;$P_</span><span class="se">{{</span><span class="s1">\Sigma m_\nu = </span><span class="si">{</span><span class="n">mass_nonzero</span><span class="si">}</span><span class="s1">\, \mathrm</span><span class="se">{{</span><span class="s1">eV</span><span class="se">}}}}</span><span class="s1">&#39;</span>
    <span class="sa">rf</span><span class="s1">&#39;/P_</span><span class="se">{{</span><span class="s1">\Sigma m_\nu = 0</span><span class="se">}}</span><span class="s1"> - 1\, [\%]$&#39;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/plot.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>As usual, to run the script, save it as e.g. <code class="docutils literal notranslate"><span class="pre">output/tutorial-7.2/plot.py</span></code>
and invoke</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span>-m<span class="w"> </span>output/tutorial-7.2/plot.py
</pre></div>
</div>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">output/tutorial-7.2/plot.png</span></code> should show that letting the
neutrinos have mass results in a few percent suppression of the matter power
spectrum. At intermediary <span class="math notranslate nohighlight">\(k\)</span> the simulation and linear relative power
spectra agree, whereas they do not for the smallest and largest <span class="math notranslate nohighlight">\(k\)</span>.
In the case of large <span class="math notranslate nohighlight">\(k\)</span>, you should see that the non-linear solution
forms a trough below the linear one, before rising up above it near the
largest <span class="math notranslate nohighlight">\(k\)</span> shown. This is the well-known non-linear suppression dip,
the low-<span class="math notranslate nohighlight">\(k\)</span> end of which marks the beginning of the non-linear regime.
We thus trust the simulated results at the high-<span class="math notranslate nohighlight">\(k\)</span> end of the plot,
while we trust the linear results at the low-<span class="math notranslate nohighlight">\(k\)</span> end.</p>
<h3>Adding gravitation from massive neutrinos</h3><p>The hope is now to be able to correct the simulated relative power spectrum at
low <span class="math notranslate nohighlight">\(k\)</span> by including the missing species to the simulation, without this
altering the high-<span class="math notranslate nohighlight">\(k\)</span> behaviour. Besides <code class="docutils literal notranslate"><span class="pre">'massive</span> <span class="pre">neutrino'</span></code>, we
should not forget about <code class="docutils literal notranslate"><span class="pre">'photon'</span></code> and <code class="docutils literal notranslate"><span class="pre">'metric'</span></code>. Note that
<code class="docutils literal notranslate"><span class="pre">'massive</span> <span class="pre">neutrino'</span></code> is not considered part of <code class="docutils literal notranslate"><span class="pre">'radiation'</span></code>. We can
however just write <code class="docutils literal notranslate"><span class="pre">'neutrino'</span></code>, as this refers to all neutrinos (massive
(‚Äòncdm‚Äô) as well as massless (‚Äòur‚Äô)) present in the cosmology. To rerun both
cosmologies with all linear species included, we might call <code class="docutils literal notranslate"><span class="pre">concept</span></code> within
a Bash for-loop:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>mass<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span>.1<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-p<span class="w"> </span>param/tutorial-7.2<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_mass = </span><span class="nv">$mass</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;photon + neutrino + metric&#39;&quot;</span>
<span class="k">done</span>
</pre></div>
</div>
<p>Once completed, redo the plot. You should find that including the linear
species did indeed correct the large-scale behaviour while leaving the
small-scale behaviour intact.</p>
<h3>Tweaking the CLASS computation</h3><p>Though better agreement with linear theory is achieved after the inclusion of
the linear species, the relative spectrum is now also more jagged. This added
noise stems from the massive neutrinos, the evolution of which is not solved
perfectly by CLASS. A large set of general and massive neutrino specific CLASS
precision parameters exist, which can remedy this problem.</p>
<p>Here we shall look at just one such CLASS parameter; <code class="docutils literal notranslate"><span class="pre">'evolver'</span></code>. This sets
the ODE solver to be used by CLASS, and may be either <code class="docutils literal notranslate"><span class="pre">0</span></code> (Runge-Kutta
Cash-Karp) or <code class="docutils literal notranslate"><span class="pre">1</span></code> (ndf15, the default). For high-precision CLASS
computations used for <em>N</em>-body simulations, it is generally preferable to
switch to the Runge-Kutta solver. To do this, just add</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the Runge-Kutta evolver</span>
<span class="s1">&#39;evolver&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</pre></div>
</div>
<p>to the <code class="docutils literal notranslate"><span class="pre">class_params</span></code> in the parameter file.</p>
<p>With this change, rerun the two simulations with linear species included (you
may also rerun all four simulations, but the matter-only ones are hardly
affected by the change to <code class="docutils literal notranslate"><span class="pre">'evolver'</span></code>). After re-plotting, the simulated
relative power spectrum should have been smoothed out at low <span class="math notranslate nohighlight">\(k\)</span>,
showing excellent agreement with the linear prediction.</p>
</section>
<section id="dynamical-dark-energy">
<span id="id3"></span><h2><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">7.3. </span>Dynamical dark energy</a><a class="headerlink" href="#dynamical-dark-energy" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>This subsection investigates how to perform simulations where dark energy is
dynamic, specifically using the equation of state
<span class="math notranslate nohighlight">\(w(a) = w_0 + (1 - a)w_a\)</span>. Beyond just changing the background
evolution, having <span class="math notranslate nohighlight">\(w \neq -1\)</span> also causes perturbations within the dark
energy, leading to an additional gravitational tug. If you‚Äôre interested in
the physics of dark energy perturbations as well as their implementation in
CO<em>N</em>CEPT, we refer to the paper on
‚Äò<a class="reference internal" href="../publications.html#dark-energy-perturbations-in-nbody-simulations"><span class="std std-ref">Dark energy perturbations in ùòï-body simulations</span></a>‚Äô.</p>
<h3>Cosmological constant <span class="math notranslate nohighlight">\(\Lambda\)</span></h3><p>So far, this tutorial has mentioned nothing about dark energy, but really it
has been there all along, as a cosmological constant <span class="math notranslate nohighlight">\(\Lambda\)</span> affecting
the background evolution.</p>
<p>CO<em>N</em>CEPT assumes the universe to be flat;
<span class="math notranslate nohighlight">\(\sum_\alpha \Omega_\alpha = 1\)</span>, <span class="math notranslate nohighlight">\(\alpha\)</span> running over all
species. Written out in the standard cosmologies we have looked at thus far,
this looks like</p>
<div class="math notranslate nohighlight">
\[  \Omega_{\text{b}}
+ \Omega_{\text{cdm}}
+ \Omega_{\gamma}
+ \Omega_{\nu}
+ \Omega_{\Lambda}
= 1\, ,\]</div>
<p>where <span class="math notranslate nohighlight">\(\Omega_{\text{b}}\)</span> and <span class="math notranslate nohighlight">\(\Omega_{\text{cdm}}\)</span> are defined
through the <code class="docutils literal notranslate"><span class="pre">Œ©b</span></code> and <code class="docutils literal notranslate"><span class="pre">Œ©cdm</span></code> CO<em>N</em>CEPT parameters, while
<span class="math notranslate nohighlight">\(\Omega_{\gamma}\)</span> (photons) and <span class="math notranslate nohighlight">\(\Omega_{\nu}\)</span> (massless and
massive neutrinos) are defined through CLASS parameters (typically,
<span class="math notranslate nohighlight">\(\Omega_{\gamma}\)</span> is defined implicitly through the CMB temperature
<code class="docutils literal notranslate"><span class="pre">class_params['T_cmb']</span></code> while <span class="math notranslate nohighlight">\(\Omega_{\nu}\)</span> is defined implicitly
through the effective number of massless neutrino species
<code class="docutils literal notranslate"><span class="pre">class_params['N_ur']</span></code>, the number of massive neutrino species
<code class="docutils literal notranslate"><span class="pre">class_params['N_ncdm']</span></code> and <code class="docutils literal notranslate"><span class="pre">class_params['deg_ncdm']</span></code>, their masses
<code class="docutils literal notranslate"><span class="pre">class_params['m_ncdm']</span></code> and temperatures <code class="docutils literal notranslate"><span class="pre">class_params['T_ncdm']</span></code>). The
remaining dark energy density <span class="math notranslate nohighlight">\(\Omega_{\Lambda}\)</span> is simply chosen as to
ensure a flat universe.</p>
<p>Though <span class="math notranslate nohighlight">\(\Lambda\)</span> is present, it does not tug on the matter (or anything
else) as it remains completely homogeneous throughout time, which is why we
never need to include it as a linear species.</p>
<h3>Dynamical dark energy</h3><p>We can set <span class="math notranslate nohighlight">\(w_0\)</span> and <span class="math notranslate nohighlight">\(w_a\)</span> through the CLASS parameters
<code class="docutils literal notranslate"><span class="pre">'w0_fld'</span></code> and <code class="docutils literal notranslate"><span class="pre">'wa_fld'</span></code>. In CLASS, the cosmological constant is
implemented as a separate species, rather than as the special case
<span class="math notranslate nohighlight">\(w_0 = -1\)</span>, <span class="math notranslate nohighlight">\(w_a = 0\)</span> of the dynamical dark energy species (in
CLASS called ‚Äòfld‚Äô for dark energy <strong>fl</strong>ui<strong>d</strong>). To disable the
cosmological constant, set the <code class="docutils literal notranslate"><span class="pre">'Omega_Lambda'</span></code> CLASS parameter to <code class="docutils literal notranslate"><span class="pre">0</span></code>. In
total, specifying dynamical dark energy could then look like</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">class_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Disable cosmological constant</span>
    <span class="s1">&#39;Omega_Lambda&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="c1"># Dark energy fluid parameters</span>
    <span class="s1">&#39;w0_fld&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="s1">&#39;wa_fld&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To test the effect on the matter from switching from <span class="math notranslate nohighlight">\(\Lambda\)</span> to
dynamical dark energy (here <span class="math notranslate nohighlight">\(w_0 = -1\, \rightarrow\, w_0 = -0.7\)</span>), we
shall make use of the following parameter file, which you should save as e.g.
<code class="docutils literal notranslate"><span class="pre">param/tutorial-7.3</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="param-dynamical-dark-energy">
<div class="code-block-caption"><span class="caption-text">param/tutorial-7.3 <span class="math notranslate nohighlight">\(\,\)</span> (dynamical dark energy)</span><a class="headerlink" href="#param-dynamical-dark-energy" title="Permalink to this code">ÔÉÅ</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Non-parameter helper variable used to control the size of the simulation</span>
<span class="n">_size</span> <span class="o">=</span> <span class="mi">128</span>

<span class="c1"># Input/output</span>
<span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Non-linear matter particles</span>
    <span class="p">{</span>
        <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;matter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;N&#39;</span>      <span class="p">:</span> <span class="n">_size</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">_species</span> <span class="ow">in</span> <span class="n">_lin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_species</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">initial_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="c1"># Linear fluid component(s)</span>
        <span class="p">{</span>
            <span class="s1">&#39;species&#39;</span>        <span class="p">:</span> <span class="n">_species</span><span class="p">,</span>
            <span class="s1">&#39;gridsize&#39;</span>       <span class="p">:</span> <span class="n">_size</span><span class="p">,</span>
            <span class="s1">&#39;boltzmann order&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="n">output_dirs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">output_bases</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;powerspec</span><span class="si">{</span><span class="n">_de</span><span class="si">=}{</span><span class="n">_lin</span><span class="si">=}</span><span class="s1">&#39;</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">output_times</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">powerspec_select</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
<span class="p">}</span>

<span class="c1"># Numerics</span>
<span class="n">boxsize</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">Gpc</span>
<span class="n">potential_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;gridsize&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;p3m&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">_size</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1"># Cosmology</span>
<span class="n">H0</span>      <span class="o">=</span> <span class="mi">67</span><span class="o">*</span><span class="n">km</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">Mpc</span><span class="p">)</span>
<span class="n">Œ©b</span>      <span class="o">=</span> <span class="mf">0.049</span>
<span class="n">Œ©cdm</span>    <span class="o">=</span> <span class="mf">0.27</span>
<span class="n">a_begin</span> <span class="o">=</span> <span class="mf">0.1</span><span class="hll"><span class="k">if</span> <span class="n">_de</span> <span class="o">!=</span> <span class="s1">&#39;Lambda&#39;</span><span class="p">:</span></span><span class="hll">    <span class="n">class_params</span> <span class="o">=</span> <span class="p">{</span></span><span class="hll">        <span class="c1"># Disable cosmological constant</span></span><span class="hll">        <span class="s1">&#39;Omega_Lambda&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span></span><span class="hll">        <span class="c1"># Dark energy fluid parameters</span></span><span class="hll">        <span class="s1">&#39;w0_fld&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">,</span></span><span class="hll">        <span class="s1">&#39;wa_fld&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span></span><span class="hll">        <span class="s1">&#39;cs2_fld&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span></span><span class="hll">    <span class="p">}</span></span>
<span class="c1"># Simulation</span><span class="hll"><span class="n">Œît_base_background_factor</span> <span class="o">=</span> <span class="mi">2</span></span><span class="hll"><span class="n">Œît_base_nonlinear_factor</span>  <span class="o">=</span> <span class="mi">2</span></span><span class="hll"><span class="n">N_rungs</span>                   <span class="o">=</span> <span class="mi">1</span></span>
<span class="c1"># Non-parameter helper variables which should</span>
<span class="c1"># be supplied as command-line parameters.</span><span class="hll"><span class="n">_de</span>  <span class="o">=</span> <span class="s1">&#39;Lambda&#39;</span>  <span class="c1"># type of dark energy</span></span><span class="n">_lin</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>        <span class="c1"># linear species to include</span>
</pre></div>
</div>
</div>
<p>The parameter file is set up to use <span class="math notranslate nohighlight">\(\Lambda\)</span> by default, while
dynamical dark energy is enabled by supplying <code class="docutils literal notranslate"><span class="pre">-c</span> <span class="pre">&quot;_de</span> <span class="pre">=</span> <span class="pre">'dynamical'&quot;</span></code>. One
can also supply <code class="docutils literal notranslate"><span class="pre">-c</span> <span class="pre">&quot;_de</span> <span class="pre">=</span> <span class="pre">'Lambda'&quot;</span></code> to explicitly select <span class="math notranslate nohighlight">\(\Lambda\)</span>.
Perform a simulation using both types of dark energy using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>de<span class="w"> </span><span class="k">in</span><span class="w"> </span>Lambda<span class="w"> </span>dynamical<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-p<span class="w"> </span>param/tutorial-7.3<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_de = &#39;</span><span class="nv">$de</span><span class="s2">&#39;&quot;</span>
<span class="k">done</span>
</pre></div>
</div>
<p>The parameter specifications <code class="docutils literal notranslate"><span class="pre">Œît_base_background_factor</span> <span class="pre">=</span> <span class="pre">2</span></code> and
<code class="docutils literal notranslate"><span class="pre">Œît_base_nonlinear_factor</span> <span class="pre">=</span> <span class="pre">2</span></code> double the allowable time step size, while
<code class="docutils literal notranslate"><span class="pre">N_rungs</span> <span class="pre">=</span> <span class="pre">1</span></code> effectively disables the adaptive time-stepping. In addition,
we start the simulation rather late at <code class="docutils literal notranslate"><span class="pre">a_begin</span> <span class="pre">=</span> <span class="pre">0.1</span></code>, as the effects from
dark energy show up only at late times. All of this is just to speed up the
simulations, as we do not require excellent precision.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The (global) time step size during the simulation is limited by a set of
conditions/limiters, each classified as either a ‚Äòbackground‚Äô or a
‚Äònon-linear‚Äô condition. The maximum allowed time step size within each
category is scaled by the <code class="docutils literal notranslate"><span class="pre">Œît_base_background_factor</span></code> and
<code class="docutils literal notranslate"><span class="pre">Œît_base_nonlinear_factor</span></code> parameter, respectively.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The adaptive particle time-stepping is a feature enabled by default when
using the P¬≥M method, which assigns separate time step sizes to the
different particles, allowing for small time steps in dense regions and
large time steps in less dense regions, achieving both accuracy and
numerical efficiency. The possible particle time step sizes are exactly the
base time step size divided by <span class="math notranslate nohighlight">\(2^n\)</span>, where
<span class="math notranslate nohighlight">\(n \in \{0, 1, 2, \dots\}\)</span> is referred to as the <em>rung</em>. The number
of available rungs (and thus the minimum allowed particle time step) is
determined through the <code class="docutils literal notranslate"><span class="pre">N_rungs</span></code> parameter. With <code class="docutils literal notranslate"><span class="pre">N_rungs</span> <span class="pre">=</span> <span class="pre">1</span></code>, all
particles are kept fixed at rung 0, i.e. the base time step, and so no
adaptive time-stepping takes place. The distribution of particles across
all rungs is printed at the start of each time step, for <code class="docutils literal notranslate"><span class="pre">N_rungs</span> <span class="pre">&gt;</span> <span class="pre">1</span></code>.</p>
</div>
<p>To make the usual plot of the relative power spectrum ‚Äî this time comparing
the matter spectrum within a cosmology with a cosmological constant
(<span class="math notranslate nohighlight">\(w = -1\)</span>) to one with dynamical dark energy (here <span class="math notranslate nohighlight">\(w = -0.7\)</span>) ‚Äî
we shall make use of the following plotting script:</p>
<div class="literal-block-wrapper docutils container" id="plot-dynamical-dark-energy">
<div class="code-block-caption"><span class="caption-text">output/tutorial-7.3/plot.py <span class="math notranslate nohighlight">\(\,\)</span> (dynamical dark energy)</span><a class="headerlink" href="#plot-dynamical-dark-energy" title="Permalink to this code">ÔÉÅ</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span><span class="p">;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Read in data</span>
<span class="n">this_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">P_sims</span><span class="p">,</span> <span class="n">P_lins</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/powerspec*&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">):</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?=_(.*?)=(.*?)_)&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> = &quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">P_sim</span><span class="p">,</span> <span class="n">P_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">P_lin</span><span class="p">)</span>
    <span class="n">P_sims</span><span class="p">[</span><span class="n">de</span><span class="p">,</span> <span class="n">lin</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_sim</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">P_lins</span><span class="p">[</span><span class="n">de</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">P_lin</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">linestyles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">de</span><span class="p">,</span> <span class="n">lin</span><span class="p">),</span> <span class="n">P_sim</span> <span class="ow">in</span> <span class="n">P_sims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">de</span> <span class="o">==</span> <span class="s1">&#39;Lambda&#39;</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">P_sim_ref</span> <span class="o">=</span> <span class="n">P_sims</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="s1">&#39;Lambda&#39;</span><span class="p">,</span> <span class="n">lin</span><span class="p">))</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;simulation: </span><span class="si">{</span><span class="n">lin</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">P_sim_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">P_sim_ref</span> <span class="o">=</span> <span class="n">P_sims</span><span class="p">[</span><span class="s1">&#39;Lambda&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39; (dynamical sim only)&#39;</span>
    <span class="n">P_rel</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_sim</span><span class="o">/</span><span class="n">P_sim_ref</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
    <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyles</span><span class="p">[</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">P_rel</span><span class="p">,</span> <span class="mf">5e-3</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">linestyles</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P_rel</span><span class="p">,</span> <span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">P_lins</span><span class="p">[</span><span class="s1">&#39;dynamical&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">P_lins</span><span class="p">[</span><span class="s1">&#39;Lambda&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k\, [\mathrm</span><span class="si">{Mpc}</span><span class="s1">^{-1}]$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$P_{\mathrm</span><span class="si">{dynamical}</span><span class="s1">}/P_{\Lambda} - 1\, [\%]$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/plot.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Save this to e.g. <code class="docutils literal notranslate"><span class="pre">output/tutorial-7.3/plot.py</span></code> and run it using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span>-m<span class="w"> </span>output/tutorial-7.3/plot.py
</pre></div>
</div>
<p>The generated plot should show that the matter power is reduced quite a bit
when switching to using the dynamical dark energy. At large <span class="math notranslate nohighlight">\(k\)</span>, we see
the usual non-linear suppression dip. At low/linear <span class="math notranslate nohighlight">\(k\)</span>, the power
suppression is larger in the simulation power spectrum than in the linear one.
This is due to inhomogeneities forming in the dark energy species itself, the
tug on matter we have not incorporated into the simulation. This effect is
enlarged as we <a class="reference internal" href="#param-dynamical-dark-energy"><span class="std std-ref">have specified</span></a> a low dark
energy sound speed <code class="docutils literal notranslate"><span class="pre">'cs2_fld'</span></code> (given in units of the speed of light
squared, <span class="math notranslate nohighlight">\(c^2\)</span>).</p>
<h3>Adding gravitation from dark energy perturbations</h3><p>As usual, the missing gravity can be incorporated into the simulation by
including the missing species in the simulation as a linear component. The
parameter file has once again been set up to be able to do this via the
<code class="docutils literal notranslate"><span class="pre">_lin</span></code> command-line parameter. To run both cosmologies again, this time
including all linear species, do e.g.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>de<span class="w"> </span><span class="k">in</span><span class="w"> </span>Lambda<span class="w"> </span>dynamical<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-p<span class="w"> </span>param/tutorial-7.3<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_de = &#39;</span><span class="nv">$de</span><span class="s2">&#39;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;radiation + dark energy + metric&#39;&quot;</span>
<span class="k">done</span>
</pre></div>
</div>
<p>where ‚Äòradiation‚Äô includes the photons and massless neutrinos supplied by
CLASS by default.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the above, we include dark energy as part of the linear species even
when we run with <span class="math notranslate nohighlight">\(\Lambda\)</span>. Here there are no dark energy
perturbations, and so this does not make a difference. It is allowed
because in CO<em>N</em>CEPT, <code class="docutils literal notranslate"><span class="pre">'dark</span> <span class="pre">energy'</span></code> maps to whatever kind of dark
energy is available within the current simulation; <span class="math notranslate nohighlight">\(\Lambda\)</span> or
dynamical dark energy (or both). Their individual names are
<code class="docutils literal notranslate"><span class="pre">'cosmological</span> <span class="pre">constant'</span></code> and <code class="docutils literal notranslate"><span class="pre">'dark</span> <span class="pre">energy</span> <span class="pre">fluid'</span></code>, respectively.</p>
</div>
<p>After re-plotting, you should see that the simulation spectrum now matches
the linear prediction at low <span class="math notranslate nohighlight">\(k\)</span>.</p>
<p>Though including all species ‚Äî i.e. also photons and neutrinos ‚Äî is what
should be done for production runs, it can be educational to run with fewer
linear species, to separate out their individual effects on the matter
spectrum. Besides being small, the effects from radiation perturbations should
be very close to identical between the two cosmologies. We thus expect effects
from radiation to be completely negligible for the relative power
spectrum. To test this, perform a simulation with dynamical dark energy,
including only dark energy as a linear species:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.3<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_de = &#39;dynamical&#39;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;dark energy&#39;&quot;</span>
</pre></div>
</div>
<p>If you now redo the plot, a relative spectrum between the newly run simulation
and the <span class="math notranslate nohighlight">\(\Lambda\)</span> simulation without any linear species will be added.
You will see that though it‚Äôs close, it has a bit too much power suppression
at low <span class="math notranslate nohighlight">\(k\)</span>.</p>
<p>The missing power is not due to the missing radiation, but rather the missing
gravity from the rather large pressure perturbations in the dark energy, which
is accounted for by the fictitious metric species. Performing a simulation
including the metric as well,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.3<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_de = &#39;dynamical&#39;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;dark energy + metric&#39;&quot;</span>
</pre></div>
</div>
<p>and re-plotting, we see that we indeed achieve nearly exactly the same result
as when running with radiation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As the metric always contains the total gravitational contribution from
momentum, pressure and shear perturbations of all species, it is not
possible to completely separate out the gravitational effects from each
species using this set-up. For example, the last simulation above <em>does</em>
include some photon and neutrino gravity, since the metric still contains
contributions from their momentum, pressure and shear perturbations. The
<span class="math notranslate nohighlight">\(\Lambda\)</span> simulation with which it is paired up for the plot does
not, however, as here the simulation is performed without including
the metric.</p>
</div>
</section>
<section id="decaying-cold-dark-matter">
<span id="id4"></span><h2><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">7.4. </span>Decaying cold dark matter</a><a class="headerlink" href="#decaying-cold-dark-matter" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>This subsection deals with the case of <span class="bolditalic">d</span><em>ecaying</em> <strong>c</strong>old
<strong>d</strong>ark <strong>m</strong>atter (‚Äòdcdm‚Äô), in particular the scenario where it decays
to some new form of massless non-interacting radiation; what we might call
<strong>d</strong>ark <strong>r</strong>adiation or <strong>d</strong>ecay <strong>r</strong>adiation (‚Äòdr‚Äô). While
the decay radiation is handled in exactly the same way as was done for other
linear species in the previous subsections, the decaying cold dark matter
itself is simulated using particles. To keep things general, we allow for
having both stable and unstable cold dark matter within the same simulation,
and so we think of dcdm as an entirely new species, separate from the usual,
stable cdm.</p>
<p>If you‚Äôre interested in the details of the physics of decaying cold dark
matter as well as its implementation in CO<em>N</em>CEPT, we refer to the paper
on
‚Äò<a class="reference internal" href="../publications.html#fully-relativistic-treatment-of-decaying-cold-dark-matter-in-nbody-simulations"><span class="std std-ref">Fully relativistic treatment of decaying cold dark matter in ùòï-body simulations</span></a>‚Äô.</p>
<h3>Particle-only simulations</h3><p>We denote the rate of decay for the new decaying cold dark matter species by
<span class="math notranslate nohighlight">\(\Gamma_{\text{dcdm}}\)</span>. We further wish to specify the amount of dcdm
today, <span class="math notranslate nohighlight">\(\Omega_{\text{dcdm}}\)</span>, but as this depends highly on the decay
rate <span class="math notranslate nohighlight">\(\Gamma_{\text{dcdm}}\)</span>, this is not a good parameter. Instead we
make use of <span class="math notranslate nohighlight">\(\widetilde{\Omega}_{\text{dcdm}}\)</span>, which we define to be
the energy density parameter that dcdm <em>would</em> have had, had
<span class="math notranslate nohighlight">\(\Gamma_{\text{dcdm}} = 0\)</span> (in which case dcdm and cdm would be
indistinguishable). Finally, rather than specifying
<span class="math notranslate nohighlight">\(\Omega_{\text{cdm}}\)</span> and <span class="math notranslate nohighlight">\(\widetilde{\Omega}_{\text{dcdm}}\)</span>
separately, we re-parametrise these as the <em>total</em> (stable and decaying) cold
dark matter energy density
<span class="math notranslate nohighlight">\((\Omega_{\text{cdm}} + \widetilde{\Omega}_{\text{dcdm}})\)</span>, as well as
the fraction of this which is of the decaying kind;</p>
<div class="math notranslate nohighlight">
\[f_{\text{dcdm}} \equiv
      \frac{\widetilde{\Omega}_{\text{dcdm}}}{\Omega_{\text{cdm}}
    + \widetilde{\Omega}_{\text{dcdm}}}\, .\]</div>
<p>Below you‚Äôll find a parameter file set up to run simulations with dcdm, which
you should save as e.g. <code class="docutils literal notranslate"><span class="pre">param/tutorial-7.4</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="param-decaying-cold-dark-matter">
<div class="code-block-caption"><span class="caption-text">param/tutorial-7.4 <span class="math notranslate nohighlight">\(\,\)</span> (decaying cold dark matter)</span><a class="headerlink" href="#param-decaying-cold-dark-matter" title="Permalink to this code">ÔÉÅ</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Non-parameter helper variable used to control the size of the simulation</span>
<span class="n">_size</span> <span class="o">=</span> <span class="mi">96</span>
<span> </span><span class="hll"><span class="c1"># Non-parameter helper variables used to control the dcdm cosmology</span></span><span class="hll"><span class="n">_Œ©_cdm_plus_dcdm</span> <span class="o">=</span> <span class="mf">0.27</span>  <span class="c1"># total amount of stable and decaying cold dark matter</span></span><span class="hll"><span class="n">_Œì</span> <span class="o">=</span> <span class="mi">80</span><span class="o">*</span><span class="n">km</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">Mpc</span><span class="p">)</span>       <span class="c1"># decay rate</span></span>
<span class="c1"># Input/output</span>
<span class="k">if</span> <span class="n">_combine</span><span class="p">:</span>
    <span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># Non-linear (total) matter particles</span>
        <span class="p">{</span><span class="hll">            <span class="s1">&#39;name&#39;</span>   <span class="p">:</span> <span class="s1">&#39;total matter&#39;</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="p">(</span></span><span class="hll">                <span class="s1">&#39;baryon + cold dark matter&#39;</span></span><span class="hll">                <span class="o">+</span> <span class="p">(</span><span class="s1">&#39; + decaying cold dark matter&#39;</span> <span class="k">if</span> <span class="n">_frac</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></span><span class="hll">            <span class="p">),</span></span>            <span class="s1">&#39;N&#39;</span>      <span class="p">:</span> <span class="n">_size</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Assume 0 &lt; _frac &lt; 1</span>
    <span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># Non-linear baryon and (stable) cold dark matter particles</span>
        <span class="p">{</span><span class="hll">            <span class="s1">&#39;name&#39;</span>   <span class="p">:</span> <span class="s1">&#39;stable matter&#39;</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;baryon + cold dark matter&#39;</span><span class="p">,</span></span>            <span class="s1">&#39;N&#39;</span>      <span class="p">:</span> <span class="n">_size</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">},</span><span class="hll">        <span class="c1"># Non-linear decaying cold dark matter particles</span></span><span class="hll">        <span class="p">{</span></span><span class="hll">            <span class="s1">&#39;name&#39;</span>   <span class="p">:</span> <span class="s1">&#39;decaying matter&#39;</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;decaying cold dark matter&#39;</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;N&#39;</span>      <span class="p">:</span> <span class="n">_size</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span></span><span class="hll">        <span class="p">},</span></span>    <span class="p">]</span>
<span class="k">for</span> <span class="n">_species</span> <span class="ow">in</span> <span class="n">_lin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_species</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">initial_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="c1"># Linear fluid component(s)</span>
        <span class="p">{</span>
            <span class="s1">&#39;species&#39;</span>        <span class="p">:</span> <span class="n">_species</span><span class="p">,</span>
            <span class="s1">&#39;gridsize&#39;</span>       <span class="p">:</span> <span class="n">_size</span><span class="p">,</span>
            <span class="s1">&#39;boltzmann order&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="n">output_dirs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">output_bases</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;powerspec_</span><span class="si">{</span><span class="n">boxsize</span><span class="si">=}{</span><span class="n">_frac</span><span class="si">=}{</span><span class="n">_lin</span><span class="si">=}{</span><span class="n">_combine</span><span class="si">=}</span><span class="s1">&#39;</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">output_times</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">powerspec_select</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;total matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span><span class="hll">    <span class="p">(</span><span class="s1">&#39;stable matter&#39;</span><span class="p">,</span> <span class="s1">&#39;decaying matter&#39;</span><span class="p">):</span> <span class="o">...</span><span class="p">,</span></span><span class="p">}</span>

<span class="c1"># Numerics</span>
<span class="n">boxsize</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">Gpc</span>
<span class="n">potential_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;gridsize&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;p3m&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">_size</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1"># Cosmology</span>
<span class="n">H0</span>      <span class="o">=</span> <span class="mi">67</span><span class="o">*</span><span class="n">km</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">Mpc</span><span class="p">)</span>
<span class="n">Œ©b</span>      <span class="o">=</span> <span class="mf">0.049</span><span class="hll"><span class="n">Œ©cdm</span>    <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_frac</span><span class="p">)</span><span class="o">*</span><span class="n">_Œ©_cdm_plus_dcdm</span></span><span class="n">a_begin</span> <span class="o">=</span> <span class="mf">0.02</span><span class="hll"><span class="k">if</span> <span class="n">_frac</span><span class="p">:</span></span><span class="hll">    <span class="n">class_params</span> <span class="o">=</span> <span class="p">{</span></span><span class="hll">        <span class="c1"># Decaying cold dark matter parameters</span></span><span class="hll">        <span class="s1">&#39;Omega_ini_dcdm&#39;</span><span class="p">:</span> <span class="n">_frac</span><span class="o">*</span><span class="n">_Œ©_cdm_plus_dcdm</span><span class="p">,</span></span><span class="hll">        <span class="s1">&#39;Gamma_dcdm&#39;</span>    <span class="p">:</span> <span class="n">_Œì</span><span class="o">/</span><span class="p">(</span><span class="n">km</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">Mpc</span><span class="p">)),</span></span><span class="hll">    <span class="p">}</span></span>
<span class="c1"># Physics</span>
<span class="n">select_forces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;particles&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="s1">&#39;p3m&#39;</span><span class="p">},</span>
    <span class="s1">&#39;fluid&#39;</span>    <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="s1">&#39;pm&#39;</span><span class="p">},</span>
<span class="p">}</span><span class="hll"><span class="k">if</span> <span class="s1">&#39;lapse&#39;</span> <span class="ow">in</span> <span class="n">_lin</span><span class="p">:</span></span><span class="hll">    <span class="n">select_forces</span> <span class="o">|=</span> <span class="p">{</span></span><span class="hll">        <span class="s1">&#39;decaying matter&#39;</span><span class="p">:</span> <span class="s1">&#39;lapse&#39;</span><span class="p">,</span></span><span class="hll">        <span class="s1">&#39;total matter&#39;</span>   <span class="p">:</span> <span class="s1">&#39;lapse&#39;</span><span class="p">,</span></span><span class="hll">    <span class="p">}</span></span>
<span class="c1"># Simulation</span>
<span class="n">primordial_amplitude_fixed</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Non-parameter helper variables which should</span>
<span class="c1"># be supplied as command-line parameters.</span>
<span class="n">_lin</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span>    <span class="c1"># linear species to include</span><span class="hll"><span class="n">_frac</span>    <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># fraction of total cold dark matter which is decaying</span></span><span class="hll"><span class="n">_combine</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># combine decaying and stable matter into a single component?</span></span></pre></div>
</div>
</div>
<p>Begin by running this without any additional command-line parameters;</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span>-p<span class="w"> </span>param/tutorial-7.4
</pre></div>
</div>
<p>which performs a standard simulation with just stable matter (baryons and cold
dark matter).</p>
<p>In the parameter file, the dcdm parameters <span class="math notranslate nohighlight">\(\Gamma_{\text{dcdm}}\)</span>,
<span class="math notranslate nohighlight">\((\Omega_{\text{cdm}} + \widetilde{\Omega}_{\text{dcdm}})\)</span> and
<span class="math notranslate nohighlight">\(f_{\text{dcdm}}\)</span> are called <code class="docutils literal notranslate"><span class="pre">_Œì</span></code>, <code class="docutils literal notranslate"><span class="pre">_Œ©_cdm_plus_dcdm</span></code> and
<code class="docutils literal notranslate"><span class="pre">_frac</span></code>, respectively. A rather extreme value of
<span class="math notranslate nohighlight">\(\Gamma_{\text{dcdm}} = 80\, \text{km}\, \text{s}^{-1}\, \text{Mpc}^{-1}\)</span>
is used, corresponding to a dcdm mean particle lifetime
<span class="math notranslate nohighlight">\(1/\Gamma_{\text{dcdm}}\)</span> comparable to the age of the universe, meaning
that the majority of the primordial dcdm population has decayed away at
<span class="math notranslate nohighlight">\(a = 1\)</span>.</p>
<p>To run a simulation where some of the cold dark matter is decaying, say 70%,
specify <code class="docutils literal notranslate"><span class="pre">_frac</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_frac = 0.7&quot;</span>
</pre></div>
</div>
<p>This new simulation still consists of just a single particle component, now
with a species of
<code class="docutils literal notranslate"><span class="pre">'baryon</span> <span class="pre">+</span> <span class="pre">cold</span> <span class="pre">dark</span> <span class="pre">matter</span> <span class="pre">+</span> <span class="pre">decaying</span> <span class="pre">cold</span> <span class="pre">dark</span> <span class="pre">matter'</span></code>. The decay is
taken into effect by continuously reducing the mass of each <em>N</em>-body particle
according to the decay rate, without changing the particle velocity. As the
component now represents three fundamental species, the effective ‚Äú<em>N</em>-body
decay rate‚Äù used is</p>
<div class="math notranslate nohighlight">
\[\Gamma_{\text{b}+\text{cdm}+\text{dcdm}}(a) =
    \frac{\bar{\rho}_{\text{dcdm}}(a)\Gamma_{\text{dcdm}}}{
          \bar{\rho}_{\text{b}}(a)
        + \bar{\rho}_{\text{cdm}}(a)
        + \bar{\rho}_{\text{dcdm}}(a)
    }\, .\]</div>
<p>To plot the usual relative power spectrum, this time between a cosmology with
and without decaying cold dark matter, make use of the below script:</p>
<div class="literal-block-wrapper docutils container" id="plot-decaying-cold-dark-matter">
<div class="code-block-caption"><span class="caption-text">output/tutorial-7.4/plot.py <span class="math notranslate nohighlight">\(\,\)</span> (decaying cold dark matter)</span><a class="headerlink" href="#plot-decaying-cold-dark-matter" title="Permalink to this code">ÔÉÅ</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span><span class="p">;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Read in data</span>
<span class="n">this_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">boxsizes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="n">ks</span><span class="p">,</span> <span class="n">P_sims</span><span class="p">,</span> <span class="n">P_lins</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/powerspec*&#39;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">):</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?=_(.*?)=(.*?)_)&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> = &quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
    <span class="n">boxsizes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">boxsize</span><span class="p">)</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">P_sim</span><span class="p">,</span> <span class="n">P_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">P_lin</span><span class="p">)</span>
    <span class="n">ks</span><span class="p">[</span><span class="n">boxsize</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">P_sims</span><span class="p">[</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">lin</span><span class="p">,</span> <span class="n">combine</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_sim</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">P_lins</span><span class="p">[</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">frac</span>              <span class="p">]</span> <span class="o">=</span> <span class="n">P_lin</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">frac</span><span class="p">),</span> <span class="n">P_lin</span> <span class="ow">in</span> <span class="n">P_lins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">frac</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">P_lin_ref</span> <span class="o">=</span> <span class="n">P_lins</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">boxsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">P_lin_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">ks</span><span class="p">[</span><span class="n">boxsize</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">P_lin</span><span class="o">/</span><span class="n">P_lin_ref</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span>
        <span class="n">zorder</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">linestyles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">]</span>
<span class="n">colours</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="p">(</span><span class="n">boxsize</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">lin</span><span class="p">,</span> <span class="n">combine</span><span class="p">),</span> <span class="n">P_sim</span> <span class="ow">in</span> <span class="n">P_sims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">frac</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">frac_nonzero</span> <span class="o">=</span> <span class="n">frac</span>
    <span class="n">lin_ref</span> <span class="o">=</span> <span class="n">lin</span>
    <span class="k">for</span> <span class="n">lin_ignore</span> <span class="ow">in</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;decayradiation&#39;</span><span class="p">,</span> <span class="s1">&#39;darkradiation&#39;</span><span class="p">,</span> <span class="s1">&#39;dr&#39;</span><span class="p">],</span> <span class="s1">&#39;lapse&#39;</span><span class="p">):</span>
        <span class="n">lin_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">lin_ref</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">lin_ignore</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;++&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,,&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+,&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,+&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;+,&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">P_sim_ref</span> <span class="o">=</span> <span class="n">P_sims</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">boxsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lin_ref</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">P_sim_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">ks</span><span class="p">[</span><span class="n">boxsize</span><span class="p">]</span>
    <span class="n">colour</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">colours</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">lin</span><span class="p">,</span> <span class="n">combine</span><span class="p">)),</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">colour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="n">colours</span><span class="p">[</span><span class="n">lin</span><span class="p">,</span> <span class="n">combine</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">colours</span><span class="p">)</span><span class="o">%</span><span class="mi">10</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;simulation: </span><span class="si">{</span><span class="n">lin</span><span class="w"> </span><span class="si">= }</span><span class="s1">, </span><span class="si">{</span><span class="n">combine</span><span class="w"> </span><span class="si">= }</span><span class="s1">&#39;</span>
    <span class="n">P_rel</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_sim</span><span class="o">/</span><span class="n">P_sim_ref</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
    <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyles</span><span class="p">[</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="n">P_rel</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">linestyles</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">boxsize</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxsizes</span><span class="p">):</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P_rel</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">colour</span><span class="si">}{</span><span class="n">linestyle</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">boxsize</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">boxsizes</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">xdata</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xdata</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k\, [\mathrm</span><span class="si">{Mpc}</span><span class="s1">^{-1}]$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
    <span class="sa">rf</span><span class="s1">&#39;$P_</span><span class="se">{{</span><span class="s1">f_</span><span class="se">{{</span><span class="s1">\mathrm</span><span class="se">{{</span><span class="s1">dcdm</span><span class="se">}}}}</span><span class="s1"> = </span><span class="si">{</span><span class="n">frac_nonzero</span><span class="si">}</span><span class="se">}}</span><span class="s1">&#39;</span>
    <span class="sa">rf</span><span class="s1">&#39;/P_</span><span class="se">{{</span><span class="s1">f_</span><span class="se">{{</span><span class="s1">\mathrm</span><span class="se">{{</span><span class="s1">dcdm</span><span class="se">}}}}</span><span class="s1"> = 0</span><span class="se">}}</span><span class="s1"> - 1\, [\%]$&#39;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/plot.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Save this script as e.g. <code class="docutils literal notranslate"><span class="pre">output/tutorial-7.4/plot.py</span></code> and run it using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span>-m<span class="w"> </span>output/tutorial-7.4/plot.py
</pre></div>
</div>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">plot.png</span></code> should show prominently the familiar non-linear
suppression dip on top of an already substantial drop in power due to the
decayed matter.</p>
<h3>Decay radiation</h3><p>The plot resulting from the first two simulations shows a familiar discrepancy
between the linear and non-linear result at low <span class="math notranslate nohighlight">\(k\)</span>. As usual, we may
try to fix this by including the missing species as linear components during
the simulation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>frac<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span>.7<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-p<span class="w"> </span>param/tutorial-7.4<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;photon + neutrino + metric&#39;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_frac = </span><span class="nv">$frac</span><span class="s2">&quot;</span>
<span class="k">done</span>
</pre></div>
</div>
<p>Once the above two simulations are complete, redo the plot. Adding the
photons, neutrinos and metric perturbations supplied about half of the missing
large-scale power needed to reach agreement with the linear prediction.</p>
<p>The remaining missing power should be supplied by further including the decay
radiation, of course only applicable for the dcdm simulation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;photon + neutrino + decay radiation + metric&#39;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_frac = 0.7&quot;</span>
</pre></div>
</div>
<p>Re-plotting after running the above, you should now see excellent agreement
with the linear result at large scales.</p>
<p>Studying <a class="reference internal" href="#param-decaying-cold-dark-matter"><span class="std std-ref">the parameter file</span></a>, we see
that the <code class="docutils literal notranslate"><span class="pre">'species'</span></code> of the <code class="docutils literal notranslate"><span class="pre">'total</span> <span class="pre">matter'</span></code> component gets set to
<code class="docutils literal notranslate"><span class="pre">'baryon</span> <span class="pre">+</span> <span class="pre">cold</span> <span class="pre">dark</span> <span class="pre">matter'</span></code> when <code class="docutils literal notranslate"><span class="pre">_frac</span></code> equals <code class="docutils literal notranslate"><span class="pre">0</span></code> (corresponding to
unset) and <code class="docutils literal notranslate"><span class="pre">'baryon</span> <span class="pre">+</span> <span class="pre">cold</span> <span class="pre">dark</span> <span class="pre">matter</span> <span class="pre">+</span> <span class="pre">decaying</span> <span class="pre">cold</span> <span class="pre">dark</span> <span class="pre">matter'</span></code>
otherwise. (Do not worry about the case of the variable <code class="docutils literal notranslate"><span class="pre">_combine</span></code> being
falsy. We shall make use of this special flag later.) We are used to
<code class="docutils literal notranslate"><span class="pre">'matter'</span></code> being an alias for <code class="docutils literal notranslate"><span class="pre">'baryon</span> <span class="pre">+</span> <span class="pre">cold</span> <span class="pre">dark</span> <span class="pre">matter'</span></code>, but really
it functions as a stand-in for <em>all</em> matter within the given cosmology,
including decaying cold dark matter. Go ahead and replace this needlessly
complicated expression for the <code class="docutils literal notranslate"><span class="pre">'species'</span></code> of <code class="docutils literal notranslate"><span class="pre">'total</span> <span class="pre">matter'</span></code> in
<a class="reference internal" href="#param-decaying-cold-dark-matter"><span class="std std-ref">the parameter file</span></a> with just
<code class="docutils literal notranslate"><span class="pre">'matter'</span></code>. Likewise, <code class="docutils literal notranslate"><span class="pre">'radiation'</span></code> includes not just <code class="docutils literal notranslate"><span class="pre">'photon'</span></code> and
(massless) <code class="docutils literal notranslate"><span class="pre">'neutrino'</span></code>, but also <code class="docutils literal notranslate"><span class="pre">'decay</span> <span class="pre">radiation'</span></code>, when present. With
the aforementioned change to
<a class="reference internal" href="#param-decaying-cold-dark-matter"><span class="std std-ref">the parameter file</span></a> in place, try
rerunning both the dcdm and the reference simulation using simply</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>frac<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span>.7<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-p<span class="w"> </span>param/tutorial-7.4<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;radiation + metric&#39;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_frac = </span><span class="nv">$frac</span><span class="s2">&quot;</span>
<span class="k">done</span>
</pre></div>
</div>
<p>Updating the plot, we see that the new simulation results are indeed identical
to the previous ones.</p>
<h3>Additional general relativistic effects and multiple particle components</h3><p>For most work involving dcdm simulations, the story ends here. For simulations
using very large boxes, or possibly extreme values of <span class="math notranslate nohighlight">\(f_{\text{dcdm}}\)</span>
and <span class="math notranslate nohighlight">\(\Gamma_{\text{dcdm}}\)</span>, additional effects from general relativity
show up, which one might wish to include in the simulations.</p>
<p>To begin the exploration of this extreme regime, run the same dcdm and
reference simulation as before, but in a much larger box:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>frac<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span>.7<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-p<span class="w"> </span>param/tutorial-7.4<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;boxsize = 30*Gpc&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;radiation + metric&#39;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-c<span class="w"> </span><span class="s2">&quot;_frac = </span><span class="nv">$frac</span><span class="s2">&quot;</span>
<span class="k">done</span>
</pre></div>
</div>
<p>Rerunning <code class="docutils literal notranslate"><span class="pre">plot.py</span></code>, we see that having the cold dark matter decay actually
leads to an <em>in</em>crease in power at very large scales. This increase in power
is replicated by the new dcdm simulation, though not quite enough to match the
linear result.</p>
<p>The continuous decay of all <em>N</em>-body particles happen in unison, according to
the set decay rate and the flow of cosmic time. Really though, each particle
should decay away in accordance with its own individually experienced flow of
proper time, which is affected by the local gravitational field. At linear
order, this general relativistic effect may be implemented as a correction
force applied to all decaying particles, with a strength proportional to their
decay rate. This force can be described as arising from a potential, which in
CO<em>N</em>CEPT is implemented as an energy density field from a fictitious
species ‚Äî much like the metric species ‚Äî called the <em>lapse</em> species. For
details on the physics of this lapse potential, see the paper on
‚Äò<a class="reference internal" href="../publications.html#fully-relativistic-treatment-of-decaying-cold-dark-matter-in-nbody-simulations"><span class="std std-ref">Fully relativistic treatment of decaying cold dark matter in ùòï-body simulations</span></a>‚Äô.</p>
<p>Just like the metric species needs to be assigned to a linear fluid component
in order to exist during the simulation, so does the lapse species. Simply
appending <code class="docutils literal notranslate"><span class="pre">'+</span> <span class="pre">lapse'</span></code> to our <code class="docutils literal notranslate"><span class="pre">_lin</span></code> string of linear species is no good
though, as this would include the lapse potential as part of gravity,
affecting <em>all</em> non-linear components, decaying or not (and with a force not
satisfying the required proportionality of the decay rate). Instead, what we
need is to let lapse be its own separate linear fluid component. As we‚Äôve seen
before, <a class="reference internal" href="#param-decaying-cold-dark-matter"><span class="std std-ref">the parameter file</span></a> has been
set up to allow separating linear components using ‚Äò<code class="docutils literal notranslate"><span class="pre">,</span></code>‚Äô. That is, to
properly include the lapse component, we should use
<code class="docutils literal notranslate"><span class="pre">_lin</span> <span class="pre">=</span> <span class="pre">'radiation</span> <span class="pre">+</span> <span class="pre">metric,</span> <span class="pre">lapse'</span></code>.</p>
<p>We further need to assign the new lapse force to the decaying matter
component. Studying the specification of <code class="docutils literal notranslate"><span class="pre">select_forces</span></code> in
<a class="reference internal" href="#param-decaying-cold-dark-matter"><span class="std std-ref">the parameter file</span></a>, we see that the
lapse force is already being assigned whenever <code class="docutils literal notranslate"><span class="pre">_lin</span></code> contains the substring
<code class="docutils literal notranslate"><span class="pre">'lapse'</span></code>. To run the large-box dcdm simulation with the lapse force
included then, simply do</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;boxsize = 30*Gpc&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;radiation + metric, lapse&#39;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_frac = 0.7&quot;</span>
</pre></div>
</div>
<p>Re-plotting after completion of the above run, we see that the lapse force
indeed managed to supply the necessary power boost, and only at very large
scales, as required.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the region of <span class="math notranslate nohighlight">\(k\)</span> where the relative power spectra from the
simulations in the small and large box meet, we would of course like them
to agree, whereas in fact the large-box simulations are slightly off. This
is simply a lack of resolution and can be corrected by running larger
simulations (i.e. increasing <code class="docutils literal notranslate"><span class="pre">_size</span></code>).</p>
</div>
<p>Being perhaps overly critical, we may conclude that the lapse force in fact
overdid its job, with the spectrum from the dcdm simulation now having
slightly too much power at very large scales. This small error arises from our
choice of combining the dcdm species together with the stable matter species
into a single particle component. Doing so in fact introduces new general
relativistic correction terms into the equations of motion for the particles,
which are not incorporated into CO<em>N</em>CEPT. For the physics of these
additional correction terms, we once again refer to the paper on
‚Äò<a class="reference internal" href="../publications.html#fully-relativistic-treatment-of-decaying-cold-dark-matter-in-nbody-simulations"><span class="std std-ref">Fully relativistic treatment of decaying cold dark matter in ùòï-body simulations</span></a>‚Äô.</p>
<p>To tackle this problem ‚Äî or at least confirm that it is indeed caused by
combining decaying and stable matter ‚Äî we may run a simulation which makes
use of two separate particle components; one for stable matter
(<code class="docutils literal notranslate"><span class="pre">'baryon</span> <span class="pre">+</span> <span class="pre">cold</span> <span class="pre">dark</span> <span class="pre">matter'</span></code>) and one for decaying matter
(<code class="docutils literal notranslate"><span class="pre">'decaying</span> <span class="pre">cold</span> <span class="pre">dark</span> <span class="pre">matter'</span></code>). This is done simply by listing each
particle component separately in the <code class="docutils literal notranslate"><span class="pre">initial_conditions</span></code> parameter in
<a class="reference internal" href="#param-decaying-cold-dark-matter"><span class="std std-ref">the parameter file</span></a>. Specifying
<code class="docutils literal notranslate"><span class="pre">_combine</span> <span class="pre">=</span> <span class="pre">False</span></code>, we see that
<a class="reference internal" href="#param-decaying-cold-dark-matter"><span class="std std-ref">our parameter file</span></a> file does exactly
this. We further want the produced power spectrum data file to contain the
combined power of the two particle components, rather than simply listing the
power spectra of each component separately. Looking at the specification of
<code class="docutils literal notranslate"><span class="pre">powerspec_select</span></code> in
<a class="reference internal" href="#param-decaying-cold-dark-matter"><span class="std std-ref">the parameter file</span></a>, we see that
power spectra are to be produced of <code class="docutils literal notranslate"><span class="pre">'total</span> <span class="pre">matter'</span></code> and
<code class="docutils literal notranslate"><span class="pre">('stable</span> <span class="pre">matter',</span> <span class="pre">'decaying</span> <span class="pre">matter')</span></code>. We are used to having these
specifications refer to our non-linear component through its species (usually
<code class="docutils literal notranslate"><span class="pre">'matter'</span></code>), but here we‚Äôve chosen to refer by <em>name</em>, where each
(arbitrary) name is set as part of the component specification within
<code class="docutils literal notranslate"><span class="pre">initial_conditions</span></code>. The tuple syntax
<code class="docutils literal notranslate"><span class="pre">(&lt;component</span> <span class="pre">0&gt;,</span> <span class="pre">&lt;component</span> <span class="pre">1&gt;,</span> <span class="pre">...)</span></code> used within <code class="docutils literal notranslate"><span class="pre">powerspec_select</span></code>
specifies the combined, total power spectrum of the listed components.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The same use of name referencing is also used when assigning the lapse
force within <code class="docutils literal notranslate"><span class="pre">select_forces</span></code>, as here we do not wish to also assign this
force to <code class="docutils literal notranslate"><span class="pre">'stable</span> <span class="pre">matter'</span></code>. It was this use of name referencing which
earlier enabled us to reformulate the <code class="docutils literal notranslate"><span class="pre">'species'</span></code> of the total matter
component, without this having any effect on the component selections
within <a class="reference internal" href="#param-decaying-cold-dark-matter"><span class="std std-ref">the parameter file</span></a>.</p>
</div>
<p>As everything is already handled within
<a class="reference internal" href="#param-decaying-cold-dark-matter"><span class="std std-ref">the parameter file</span></a>, running the
two-particle-component simulation is then as simple as</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;boxsize = 30*Gpc&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;radiation + metric, lapse&#39;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_frac = 0.7&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_combine = False&quot;</span>
</pre></div>
</div>
<p>This of course increases the computation time drastically, as we now have
twice the number of particles and several times the number of force
evaluations. Once completed, update the plot once again. You should now see
better agreement with linear theory on very large scales, but at the cost of
noise at ‚Äúsmall‚Äù (relative to the enormous box) scales.</p>
<p>The noise in the relative spectrum arise from having <span class="math notranslate nohighlight">\(96^3 + 96^3\)</span>
particles (<code class="docutils literal notranslate"><span class="pre">'stable</span> <span class="pre">matter'</span></code> plus <code class="docutils literal notranslate"><span class="pre">'decaying</span> <span class="pre">matter'</span></code>) in the dcdm
simulation and just <span class="math notranslate nohighlight">\(96^3\)</span> particles (<code class="docutils literal notranslate"><span class="pre">'total</span> <span class="pre">matter'</span></code>) in the
reference simulation. When (pre-)initialising two particle components
containing the same number of particles, CO<em>N</em>CEPT places the two sets of
particles on interleaved lattices, corresponding to
<a class="reference external" href="https://en.wikipedia.org/wiki/Cubic_crystal_system#Caesium_chloride_structure">the two simple lattices constituting a body-centered lattice</a>.
The same body-centered cubic lattice arrangement is used for the particles
within a single component when its number of particles <span class="math notranslate nohighlight">\(N = 2n^3\)</span> with
<span class="math notranslate nohighlight">\(n\in\mathbb{N}\)</span>. For the final run, then, try doubling the number of
particles for the <code class="docutils literal notranslate"><span class="pre">'total</span> <span class="pre">matter'</span></code> component within the parameter file from
<code class="docutils literal notranslate"><span class="pre">_size**3</span></code> to <code class="docutils literal notranslate"><span class="pre">2*_size**3</span></code>, then rerun the large-box reference simulation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;boxsize = 30*Gpc&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_lin = &#39;radiation + metric&#39;&quot;</span>
</pre></div>
</div>
<p>After updating the plot, the noise previously seen in the relative spectrum
using separate stable and decaying components should now be gone, leaving a
spectrum that has great agreement with linear theory all the way down to where
the smaller-box spectra begins.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As the large-box reference simulation now contains <span class="math notranslate nohighlight">\(N = 2\times 96^3\)</span>
particles while the large-box ‚Äúcombined‚Äù dcdm simulations contain
<span class="math notranslate nohighlight">\(N = 96^3\)</span> particles, the corresponding relative spectra now perform
worse than previously.</p>
</div>
</section>
<section id="non-linear-massive-neutrinos">
<span id="nonlinear-massive-neutrinos"></span><h2><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">7.5. </span>Non-linear massive neutrinos</a><a class="headerlink" href="#non-linear-massive-neutrinos" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Here we‚Äôll explore simulations with massive neutrinos, solved <em>non</em>-linearly
within CO<em>N</em>CEPT. You should have already completed the <em>linear</em>
<a class="reference internal" href="#massive-neutrinos"><span class="std std-ref">massive neutrinos</span></a> subsection of this tutorial
before carrying on with this subsection.</p>
<h3>Linear neutrinos</h3><p>The goal of this subsection is to upgrade the massive neutrinos within the
simulations from being a simple linear density field to be a non-linearly
evolved fluid. For this we shall make use of the below parameter file, which
you should save as e.g. <code class="docutils literal notranslate"><span class="pre">param/tutorial-7.5</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="param-nonlinear-massive-neutrinos">
<div class="code-block-caption"><span class="caption-text">param/tutorial-7.5 <span class="math notranslate nohighlight">\(\,\)</span> (non-linear massive neutrinos)</span><a class="headerlink" href="#param-nonlinear-massive-neutrinos" title="Permalink to this code">ÔÉÅ</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Non-parameter helper variable used to control the size of the simulation</span>
<span class="n">_size</span> <span class="o">=</span> <span class="mi">80</span>

<span class="c1"># Input/output</span>
<span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Non-linear matter particles</span>
    <span class="p">{</span>
        <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;matter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;N&#39;</span>      <span class="p">:</span> <span class="n">_size</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="c1"># Linear fluid component</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span>           <span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>
        <span class="s1">&#39;species&#39;</span>        <span class="p">:</span> <span class="s1">&#39;photon + neutrino + metric&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gridsize&#39;</span>       <span class="p">:</span> <span class="n">_size</span><span class="p">,</span>
        <span class="s1">&#39;boltzmann order&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span><span class="hll"><span class="k">if</span> <span class="n">_nunonlin</span><span class="p">:</span></span><span class="hll">    <span class="n">initial_conditions</span> <span class="o">+=</span> <span class="p">[</span></span><span class="hll">        <span class="c1"># Non-linear neutrino fluid</span></span><span class="hll">        <span class="p">{</span></span><span class="hll">            <span class="s1">&#39;name&#39;</span>           <span class="p">:</span> <span class="s1">&#39;non-linear neutrino&#39;</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;species&#39;</span>        <span class="p">:</span> <span class="s1">&#39;neutrino&#39;</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;gridsize&#39;</span>       <span class="p">:</span> <span class="n">_size</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;boltzmann order&#39;</span><span class="p">:</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span></span><span class="hll">        <span class="p">},</span></span><span class="hll">        <span class="c1"># Linear fluid component with neutrinos left out</span></span><span class="hll">        <span class="p">{</span></span><span class="hll">            <span class="s1">&#39;name&#39;</span>           <span class="p">:</span> <span class="s1">&#39;linear (no neutrino)&#39;</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;species&#39;</span>        <span class="p">:</span> <span class="s1">&#39;photon + metric&#39;</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;gridsize&#39;</span>       <span class="p">:</span> <span class="n">_size</span><span class="p">,</span></span><span class="hll">            <span class="s1">&#39;boltzmann order&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span></span><span class="hll">        <span class="p">},</span></span><span class="hll">    <span class="p">]</span></span><span class="n">output_dirs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">output_bases</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;powerspec</span><span class="si">{</span><span class="n">_mass</span><span class="si">=}{</span><span class="n">_nunonlin</span><span class="si">=}{</span><span class="n">_nutrans</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">output_times</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">powerspec_select</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span>             <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="s1">&#39;non-linear neutrino&#39;</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Numerics</span>
<span class="n">boxsize</span> <span class="o">=</span> <span class="mi">400</span><span class="o">*</span><span class="n">Mpc</span>
<span class="n">potential_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;gridsize&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;pm&#39;</span> <span class="p">:</span>   <span class="n">_size</span><span class="p">,</span>
            <span class="s1">&#39;p3m&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">_size</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1"># Cosmology</span>
<span class="n">H0</span>      <span class="o">=</span> <span class="mi">67</span><span class="o">*</span><span class="n">km</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">Mpc</span><span class="p">)</span>
<span class="n">Œ©b</span>      <span class="o">=</span> <span class="mf">0.049</span>
<span class="n">Œ©cdm</span>    <span class="o">=</span> <span class="mf">0.27</span> <span class="o">-</span> <span class="n">Œ©ŒΩ</span>
<span class="n">a_begin</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">class_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Disable massless neutrinos</span>
    <span class="s1">&#39;N_ur&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="c1"># Add 3 massive neutrinos of equal mass</span>
    <span class="s1">&#39;N_ncdm&#39;</span>  <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;deg_ncdm&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;m_ncdm&#39;</span>  <span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">_mass</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1e-100</span><span class="p">),</span>  <span class="c1"># avoid exact value of 0.0</span>
    <span class="c1"># General precision parameters</span>
    <span class="s1">&#39;evolver&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span><span class="hll">    <span class="c1"># Neutrino precision parameters</span></span><span class="hll">    <span class="s1">&#39;l_max_ncdm&#39;</span>              <span class="p">:</span> <span class="mi">200</span><span class="p">,</span></span><span class="hll">    <span class="s1">&#39;Number of momentum bins&#39;</span> <span class="p">:</span> <span class="mi">50</span><span class="p">,</span></span><span class="hll">    <span class="s1">&#39;Quadrature strategy&#39;</span>     <span class="p">:</span> <span class="mi">2</span><span class="p">,</span></span><span class="hll">    <span class="s1">&#39;ncdm_fluid_approximation&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span></span><span class="p">}</span>

<span class="c1"># Physics</span><span class="hll"><span class="k">if</span> <span class="n">_nunonlin</span><span class="p">:</span></span><span class="hll">    <span class="n">select_lives</span> <span class="o">=</span> <span class="p">{</span></span><span class="hll">        <span class="s1">&#39;linear&#39;</span>              <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_nutrans</span><span class="p">),</span></span><span class="hll">        <span class="s1">&#39;linear (no neutrino)&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">_nutrans</span><span class="p">,</span> <span class="n">inf</span><span class="p">),</span></span><span class="hll">        <span class="s1">&#39;non-linear neutrino&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">_nutrans</span><span class="p">,</span> <span class="n">inf</span><span class="p">),</span></span><span class="hll">    <span class="p">}</span></span>
<span class="c1"># Simulation</span>
<span class="n">primordial_amplitude_fixed</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Non-parameter helper variables which should</span>
<span class="c1"># be supplied as command-line parameters.</span>
<span class="n">_mass</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c1"># sum of neutrino masses in eV</span><span class="hll"><span class="n">_nunonlin</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># use non-linear neutrinos?</span></span><span class="hll"><span class="n">_nutrans</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># scale factor at which to transition to non-linear neutrinos</span></span></pre></div>
</div>
</div>
<p>Start by running this parameter file as is,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span>-p<span class="w"> </span>param/tutorial-7.5
</pre></div>
</div>
<p>which will perform a simulation with three mass<em>less</em> neutrinos, with these
as well as photons and the metric included in a combined, linear component.</p>
<p>Once done, also perform a simulation with three massive (but still linear)
neutrinos, say with <span class="math notranslate nohighlight">\(\sum m_\nu = 0.5\, \text{eV}\)</span>.
<a class="reference internal" href="#param-nonlinear-massive-neutrinos"><span class="std std-ref">The parameter file</span></a> has been set up
so that this can be achieved by supplying <code class="docutils literal notranslate"><span class="pre">_mass</span></code> as a command-line
parameter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.5<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_mass = 0.5&quot;</span>
</pre></div>
</div>
<p>With both the linear massless and the linear massive neutrino run done, plot
the results using the following plotting script:</p>
<div class="literal-block-wrapper docutils container" id="plot-nonlinear-massive-neutrinos">
<div class="code-block-caption"><span class="caption-text">output/tutorial-7.5/plot.py <span class="math notranslate nohighlight">\(\,\)</span> (non-linear massive neutrinos)</span><a class="headerlink" href="#plot-nonlinear-massive-neutrinos" title="Permalink to this code">ÔÉÅ</a></div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span><span class="p">;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Read in data</span>
<span class="n">this_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">inf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
<span class="n">P_sims</span><span class="p">,</span> <span class="n">P_lins</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/powerspec*&#39;</span><span class="p">):</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?=_(.*?)=(.*?)_)&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">):</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">P_sim</span><span class="p">,</span> <span class="n">P_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">P_lin</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">P_sims</span><span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">][</span><span class="n">mass</span><span class="p">,</span> <span class="n">nunonlin</span><span class="p">,</span> <span class="n">nutrans</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_sim</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">P_lins</span><span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">][</span><span class="n">mass</span>                   <span class="p">]</span> <span class="o">=</span> <span class="n">P_lin</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">k_ŒΩ</span><span class="p">,</span> <span class="n">P_sim</span><span class="p">,</span> <span class="n">P_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">mask_ŒΩ</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">P_lin</span><span class="p">)</span>
    <span class="n">k_ŒΩ</span> <span class="o">=</span> <span class="n">k_ŒΩ</span><span class="p">[</span><span class="n">mask_ŒΩ</span><span class="p">]</span>
    <span class="n">P_sims</span><span class="p">[</span><span class="s1">&#39;neutrino&#39;</span><span class="p">][</span><span class="n">mass</span><span class="p">,</span> <span class="n">nunonlin</span><span class="p">,</span> <span class="n">nutrans</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_sim</span><span class="p">[</span><span class="n">mask_ŒΩ</span><span class="p">]</span>
    <span class="n">P_lins</span><span class="p">[</span><span class="s1">&#39;neutrino&#39;</span><span class="p">][</span><span class="n">mass</span>                   <span class="p">]</span> <span class="o">=</span> <span class="n">P_lin</span><span class="p">[</span><span class="n">mask_ŒΩ</span><span class="p">]</span>
<span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">,</span> <span class="s1">&#39;neutrino&#39;</span><span class="p">]:</span>
    <span class="n">P_sims</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">P_sims</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">P_sims</span><span class="p">[</span><span class="n">species</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="n">P_lins</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">P_lins</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">P_lins</span><span class="p">[</span><span class="n">species</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="p">}</span>

<span class="c1"># Plot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
<span class="n">ax_w</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax_ne</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_se</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">linestyles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">]</span>
<span class="n">fmts</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="k">for</span> <span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">nunonlin</span><span class="p">,</span> <span class="n">nutrans</span><span class="p">),</span> <span class="n">P_sim</span> <span class="ow">in</span> <span class="n">P_sims</span><span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mass</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">nutrans_ref</span> <span class="ow">in</span> <span class="p">(</span><span class="n">nutrans</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">P_sim_ref</span> <span class="o">=</span> <span class="n">P_sims</span><span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nutrans_ref</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">P_sim_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_sim</span><span class="o">/</span><span class="n">P_sim_ref</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
    <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyles</span><span class="p">[</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()[:</span><span class="mi">30</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="mi">30</span><span class="p">],</span> <span class="mf">3e-2</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ax_w</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">linestyles</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="o">%</span><span class="mi">10</span><span class="si">}{</span><span class="n">linestyle</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">nunonlin</span><span class="p">:</span>
        <span class="n">fmts</span><span class="p">[</span><span class="n">mass</span><span class="p">,</span> <span class="n">nutrans</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmt</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;simulation: $\Sigma m_\nu = </span><span class="si">{</span><span class="n">mass</span><span class="si">}</span><span class="s1">$ eV, &#39;</span>
    <span class="k">if</span> <span class="n">nunonlin</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">+=</span> <span class="sa">rf</span><span class="s1">&#39;$a_</span><span class="se">{{</span><span class="s1">\nu\mathrm</span><span class="se">{{</span><span class="s1">trans</span><span class="se">}}}}</span><span class="s1"> = </span><span class="si">{</span><span class="n">nutrans</span><span class="si">:</span><span class="s1">.2g</span><span class="si">}</span><span class="s1">$&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39;linear $\nu$&#39;</span>
    <span class="n">ax_w</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
<span class="n">mass_nonzeros</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">mass</span> <span class="k">for</span> <span class="n">mass</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="ow">in</span> <span class="n">P_sims</span><span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">mass</span><span class="p">})</span>
<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>
<span class="k">for</span> <span class="n">mass_nonzero</span> <span class="ow">in</span> <span class="n">mass_nonzeros</span><span class="p">:</span>
    <span class="n">ax_w</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span>
        <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">P_lins</span><span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">][</span><span class="n">mass_nonzero</span><span class="p">]</span><span class="o">/</span><span class="n">P_lins</span><span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">mass_nonzero</span> <span class="ow">in</span> <span class="n">mass_nonzeros</span><span class="p">:</span>
    <span class="n">P_sim_ref</span> <span class="o">=</span> <span class="n">P_sims</span><span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">mass_nonzero</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">P_sim_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">nunonlin</span><span class="p">,</span> <span class="n">nutrans</span><span class="p">),</span> <span class="n">P_sim</span> <span class="ow">in</span> <span class="n">P_sims</span><span class="p">[</span><span class="s1">&#39;matter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">mass</span> <span class="o">!=</span> <span class="n">mass_nonzero</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">nunonlin</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ax_ne</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span>
            <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">P_sim</span><span class="o">/</span><span class="n">P_sim_ref</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">fmts</span><span class="p">[</span><span class="n">mass</span><span class="p">,</span> <span class="n">nutrans</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">rf</span><span class="s1">&#39;simulation: $\Sigma m_\nu = </span><span class="si">{</span><span class="n">mass</span><span class="si">}</span><span class="s1">$ eV, &#39;</span>
                <span class="sa">rf</span><span class="s1">&#39;$a_</span><span class="se">{{</span><span class="s1">\nu\mathrm</span><span class="se">{{</span><span class="s1">trans</span><span class="se">}}}}</span><span class="s1"> = </span><span class="si">{</span><span class="n">nutrans</span><span class="si">:</span><span class="s1">.2g</span><span class="si">}</span><span class="s1">$&#39;</span>
            <span class="p">),</span>
        <span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">nunonlin</span><span class="p">,</span> <span class="n">nutrans</span><span class="p">),</span> <span class="n">P_sim</span> <span class="ow">in</span> <span class="n">P_sims</span><span class="p">[</span><span class="s1">&#39;neutrino&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ax_se</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span>
        <span class="n">k_ŒΩ</span><span class="p">,</span> <span class="n">k_ŒΩ</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">P_sim</span><span class="p">,</span> <span class="n">fmts</span><span class="p">[</span><span class="n">mass</span><span class="p">,</span> <span class="n">nutrans</span><span class="p">],</span>
        <span class="n">label</span><span class="o">=</span><span class="p">(</span>
            <span class="sa">rf</span><span class="s1">&#39;simulation: $\Sigma m_\nu = </span><span class="si">{</span><span class="n">mass</span><span class="si">}</span><span class="s1">$ eV, &#39;</span>
            <span class="sa">rf</span><span class="s1">&#39;$a_</span><span class="se">{{</span><span class="s1">\nu\mathrm</span><span class="se">{{</span><span class="s1">trans</span><span class="se">}}}}</span><span class="s1"> = </span><span class="si">{</span><span class="n">nutrans</span><span class="si">:</span><span class="s1">.2g</span><span class="si">}</span><span class="s1">$&#39;</span>
        <span class="p">),</span>
    <span class="p">)</span>
<span class="n">ax_w</span> <span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax_ne</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>
<span class="k">for</span> <span class="n">mass_nonzero</span> <span class="ow">in</span> <span class="n">mass_nonzeros</span><span class="p">:</span>
    <span class="n">P_lin</span> <span class="o">=</span> <span class="n">P_lins</span><span class="p">[</span><span class="s1">&#39;neutrino&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mass_nonzero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">P_lin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">ax_se</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">k_ŒΩ</span><span class="p">,</span> <span class="n">k_ŒΩ</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">P_lin</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ax_se</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">k_ŒΩ</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k_ŒΩ</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax_w</span><span class="p">,</span> <span class="n">ax_ne</span><span class="p">,</span> <span class="n">ax_se</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k\, [\mathrm</span><span class="si">{Mpc}</span><span class="s1">^{-1}]$&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">ax_w</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
    <span class="sa">rf</span><span class="s1">&#39;$P_</span><span class="se">{{</span><span class="s1">\Sigma m_\nu &gt; 0</span><span class="se">}}</span><span class="s1">&#39;</span>
    <span class="sa">rf</span><span class="s1">&#39;/P_</span><span class="se">{{</span><span class="s1">\Sigma m_\nu = 0</span><span class="se">}}</span><span class="s1"> - 1\, [\%]$&#39;</span>
<span class="p">)</span>
<span class="n">ax_ne</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
    <span class="sa">rf</span><span class="s1">&#39;$P_</span><span class="se">{{</span><span class="s1">\mathrm</span><span class="se">{{</span><span class="s1">non‚Äêlinear</span><span class="se">}}</span><span class="s1">\,\nu</span><span class="se">}}</span><span class="s1">&#39;</span>
    <span class="sa">rf</span><span class="s1">&#39;/P_</span><span class="se">{{</span><span class="s1">\mathrm</span><span class="se">{{</span><span class="s1">linear</span><span class="se">}}</span><span class="s1">\,\nu</span><span class="se">}}</span><span class="s1"> - 1\, [\%]$&#39;</span>
<span class="p">)</span>
<span class="n">ax_se</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k^3P_{\nu}$&#39;</span><span class="p">)</span>
<span class="n">ax_ne</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/plot.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Save the plotting script to e.g. <code class="docutils literal notranslate"><span class="pre">output/tutorial-7.5/plot.py</span></code> and run
it using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span>-m<span class="w"> </span>output/tutorial-7.5/plot.py
</pre></div>
</div>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">plot.png</span></code> shows the relative matter power spectrum between
the massive and massless neutrino cosmology on the left. You should see the
usual non-linear suppression dip. The corresponding result from linear theory
is shown as well, which matches at large scales. Be careful not to confuse
completely linear theory with non-linear matter simulations containing linear
neutrinos, which again is different from the upcoming simulations treating
both matter and neutrinos non-linearly.</p>
<h3>Non-linear neutrinos</h3><p>Studying <a class="reference internal" href="#param-nonlinear-massive-neutrinos"><span class="std std-ref">the parameter file</span></a> it
should be clear that setting <code class="docutils literal notranslate"><span class="pre">_nunonlin</span> <span class="pre">=</span> <span class="pre">True</span></code> will result in two
new components within the simulation, namely <code class="docutils literal notranslate"><span class="pre">'non-linear</span> <span class="pre">neutrino'</span></code> and
<code class="docutils literal notranslate"><span class="pre">'linear</span> <span class="pre">(no</span> <span class="pre">neutrino)'</span></code>, the latter of which supplies the simulation with
photons and the metric. To not double count these species, the old component
named <code class="docutils literal notranslate"><span class="pre">'linear'</span></code> should now no longer be used. This is handled by the newly
introduced <code class="docutils literal notranslate"><span class="pre">select_lives</span></code> parameter, which we shall look into shortly. What
makes the <code class="docutils literal notranslate"><span class="pre">'non-linear</span> <span class="pre">neutrino'</span></code> component non-linear is its Boltzmann
order of <span class="math notranslate nohighlight">\(+1\)</span>, meaning that its energy and momentum density are treated
as non-linear fields ‚Äî evolved within CO<em>N</em>CEPT ‚Äî with pressure and
shear still treated linearly. See the <a class="reference internal" href="#radiation"><span class="std std-ref">radiation</span></a> subsection
for further explanation about the Boltzmann order. For details on how the
non-linear fluid evolution is implemented in CO<em>N</em>CEPT, we refer to the
paper
‚Äò<a class="reference internal" href="../publications.html#nuconcept-cosmological-neutrino-simulations-from-the-nonlinear-boltzmann-hierarchy"><span class="std std-ref">ŒΩCOùòïCEPT: Cosmological neutrino simulations from the non-linear Boltzmann hierarchy</span></a>‚Äô.</p>
<p>Run a simulation with non-linear massive neutrinos with the same mass as used
for the linear massive neutrino run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.5<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_mass = 0.5&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_nunonlin = True&quot;</span>
</pre></div>
</div>
<p>Reading the output in the terminal during the simulation, it‚Äôs clear that each
time step is now quite a bit more involved. Beyond having to additionally
evolve the energy and momentum density of the non-linear neutrinos ‚Äî which
in turn require continual realisation of the linear pressure (written as
<code class="docutils literal notranslate"><span class="pre">œÇ['trace']</span></code>) and shear (written as <code class="docutils literal notranslate"><span class="pre">œÇ[i,</span> <span class="pre">j]</span></code>) ‚Äî the number of
gravitational interactions also increases. Below we give an overview of the
different kinds of gravitational interactions at play:</p>
<ul>
<li><p>Gravity applied to <code class="docutils literal notranslate"><span class="pre">'matter'</span></code>:</p>
<blockquote>
<div><ul>
<li><p>From <code class="docutils literal notranslate"><span class="pre">'matter'</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li><p>P¬≥M (long-range)</p></li>
<li><p>P¬≥M (short-range)</p></li>
</ul>
</div></blockquote>
</li>
<li><p>From <code class="docutils literal notranslate"><span class="pre">'non-linear</span> <span class="pre">neutrino'</span></code> + <code class="docutils literal notranslate"><span class="pre">'linear</span> <span class="pre">(no</span> <span class="pre">neutrino)'</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li><p>PM</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>Gravity applied to <code class="docutils literal notranslate"><span class="pre">'non-linear</span> <span class="pre">neutrino'</span></code>:</p>
<blockquote>
<div><ul>
<li><p>From <code class="docutils literal notranslate"><span class="pre">matter</span></code> + <code class="docutils literal notranslate"><span class="pre">'non-linear</span> <span class="pre">neutrino'</span></code> + <code class="docutils literal notranslate"><span class="pre">'linear</span> <span class="pre">(no</span> <span class="pre">neutrino)'</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li><p>PM</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
</ul>
<p>All of this makes non-linear neutrino simulation slower than simulations with
linear neutrinos. Even more significant is the fact that non-linear neutrinos
require a small time step size due to the
<a class="reference external" href="https://en.wikipedia.org/wiki/Courant-Friedrichs-Lewy_condition">Courant condition</a>.
As no rung-like system exists for fluids in CO<em>N</em>CEPT, the single most
extreme fluid cell typically dictates the global time step size, slowing down
the entire simulation.</p>
<p>Once the non-linear neutrino simulation has completed, update the plot by
rerunning the plotting script. A new line will appear in the left panel, which
shows that running with non-linear neutrinos makes the non-linear suppression
dip slightly shallower. That is, treating the neutrinos non-linearly slightly
increases the matter power. This is caused by the enhanced clustering of the
neutrinos. Exactly how much of an increase in matter power we get by
substituting linear neutrinos for non-linear neutrinos is shown in the upper
right panel. For <span class="math notranslate nohighlight">\(\sum m_\nu = 0.5\, \text{eV}\)</span> it should amount to a
few per mille around the <span class="math notranslate nohighlight">\(k\)</span>‚Äôs of the non-linear suppression dip. The
lower right panel shows the power spectrum of the neutrino component, where
<span class="math notranslate nohighlight">\(k^3P_{\nu}\)</span> rather than just <span class="math notranslate nohighlight">\(P_{\nu}\)</span> is plotted, as this
results in a better view of the data. Both the non-linearly evolved neutrinos
as well as linear ones are shown.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Larger neutrino masses lead to stronger neutrino clustering, in turn
leading to further increased matter power. Though non-linear clustering in
the neutrino component itself is clearly visible in the neutrino power
spectrum even for small masses, the accompanying increase in matter power
becomes very hard to see for <span class="math notranslate nohighlight">\(\sum m_\nu \lesssim 0.1\, \text{eV}\)</span>.</p>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>The default fluid solver used within CO<em>N</em>CEPT is that of
<a class="reference external" href="https://en.wikipedia.org/wiki/MacCormack_method">MacCormack</a>. We have
found this method to be bad at handling strong clustering, and so our
implementation includes a crude fix to avoid the generation of cells
with negative densities. For large neutrino masses and/or high resolution
this may not be sufficient, in which case the code will abort, stating that
it gives up trying to repair the erroneous negative cells. We thus
recommend that you only run CO<em>N</em>CEPT with non-linear neutrinos for
<span class="math notranslate nohighlight">\(\sum m_\nu \lesssim 0.6\, \text{eV}\)</span> (3 degenerate neutrinos)
or <span class="math notranslate nohighlight">\(m_\nu \lesssim 0.2\, \text{eV}\)</span> (per neutrino).</p>
</div>
<h3>Transitioning from linear to non-linear neutrinos</h3><p>As you‚Äôve now experienced first-hand, non-linear neutrino simulations can take
a long time to complete. As written above, a major reason for this is the
small global time step size required by the non-linear neutrino fluid, leading
to many more time steps than usual. This is especially true at early times and
for light neutrinos, as here the neutrino fluid has a high pressure and thus a
high speed of sound.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At each time step of the simulation the equation of state (EoS) parameter
<span class="math notranslate nohighlight">\(w\)</span> of the non-linear neutrino component is shown. By following the
evolution of the EoS you can get an idea about how far the neutrino
component is on its path towards becoming non-relativistic and hence
matter-like, with only a small pressure.</p>
</div>
<p>As the non-linear neutrino component doesn‚Äôt significantly deviate from linear
behaviour at early times, we can save on computational resources by running
with linear neutrinos in the beginning and then transition to using non-linear
neutrinos at some scale factor value <span class="math notranslate nohighlight">\(a_{\nu\text{trans}}\)</span>.
<a class="reference internal" href="#param-nonlinear-massive-neutrinos"><span class="std std-ref">The parameter file</span></a> is set up to do
exactly this by specifying <span class="math notranslate nohighlight">\(a_{\nu\text{trans}}\)</span> as the <code class="docutils literal notranslate"><span class="pre">_nutrans</span></code>
variable. To rerun the non-linear neutrino simulation, though using linear
neutrinos for <span class="math notranslate nohighlight">\(a &lt; a_{\nu\text{trans}} = 0.1\)</span>, do</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span>param/tutorial-7.5<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_mass = 0.5&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_nunonlin = True&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="s2">&quot;_nutrans = 0.1&quot;</span>
</pre></div>
</div>
<p>The transitioning works by terminating the <code class="docutils literal notranslate"><span class="pre">'linear'</span></code> component (containing
neutrinos, photons and metric) at <span class="math notranslate nohighlight">\(a = a_{\nu\text{trans}}\)</span>, while
simultaneously activating both the <code class="docutils literal notranslate"><span class="pre">'linear</span> <span class="pre">(no</span> <span class="pre">neutrino)'</span></code> (containing
photons and metric) and the <code class="docutils literal notranslate"><span class="pre">'non-linear</span> <span class="pre">neutrino'</span></code> component. This is
achieved through the <code class="docutils literal notranslate"><span class="pre">select_lives</span></code> parameter in the
<a class="reference internal" href="#param-nonlinear-massive-neutrinos"><span class="std std-ref">the parameter file</span></a>, which maps
components to life spans in the format
<span class="math notranslate nohighlight">\((a_{\text{activate}}, a_{\text{terminate}})\)</span>. When <code class="docutils literal notranslate"><span class="pre">_nunonlin</span></code> is
<code class="docutils literal notranslate"><span class="pre">False</span></code> (default), <code class="docutils literal notranslate"><span class="pre">select_lives</span></code> is not set at all, and so all specified
components (here only <code class="docutils literal notranslate"><span class="pre">'matter'</span></code> and <code class="docutils literal notranslate"><span class="pre">'linear'</span></code>) live for the entirety of
the simulation. With <code class="docutils literal notranslate"><span class="pre">_nunonlin</span> <span class="pre">=</span> <span class="pre">True</span></code> we see that <code class="docutils literal notranslate"><span class="pre">'linear'</span></code> is only
active until the time of <code class="docutils literal notranslate"><span class="pre">_nutrans</span></code>, whereas <code class="docutils literal notranslate"><span class="pre">'linear</span> <span class="pre">(no</span> <span class="pre">neutrino)'</span></code> and
<code class="docutils literal notranslate"><span class="pre">'non-linear</span> <span class="pre">neutrino'</span></code> are first activated at the time of <code class="docutils literal notranslate"><span class="pre">_nutrans</span></code> and
then continues to be active throughout time.</p>
<p>You should find that this simulation completes significantly faster than the
previous one. Once completed and with the plot updated, you should find that
running with linear neutrinos at early times doesn‚Äôt change the results much.
In fact, the non-linear neutrino power spectra at <span class="math notranslate nohighlight">\(a = 1\)</span> looks very
close to identical. It does make a noticeable difference at high <span class="math notranslate nohighlight">\(k\)</span> for
the matter spectrum, as seen from the top right panel of the plot. However,
these (sub per mille) changes come about mostly due to the difference in
global time-stepping between the simulations, and so should not be ascribed to
early non-linearity of the neutrinos.</p>
<h3>Static time-stepping</h3><p>To confirm that the excess matter power at high <span class="math notranslate nohighlight">\(k\)</span> observed for the
simulation where the neutrino fluid is treated non-linear right from the
beginning is caused by the finer time-stepping (and as such is not directly
related to the neutrinos), let‚Äôs now rerun the non-linear neutrino simulations
where we force them to use identical time-stepping. To do this, we make use of
the <code class="docutils literal notranslate"><span class="pre">static_timestepping</span></code> <a class="reference internal" href="../parameters/simulation.html#static-timestepping"><span class="std std-ref">parameter</span></a> to record
the fine time-stepping of the simulation using non-linear neutrinos from the
beginning, and to apply this time-stepping to the simulation using the linear
<span class="math notranslate nohighlight">\(\rightarrow\)</span> non-linear transition:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">nutrans</span> <span class="ow">in</span> <span class="mi">0</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">do</span>
    <span class="o">./</span><span class="n">concept</span> \
        <span class="o">-</span><span class="n">p</span> <span class="n">param</span><span class="o">/</span><span class="n">tutorial</span><span class="o">-</span><span class="mf">7.5</span> \
        <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;_mass = 0.5&quot;</span> \
        <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;_nunonlin = True&quot;</span> \
        <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;_nutrans = $nutrans&quot;</span> \
        <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;static_timestepping = f&#39;</span><span class="si">{path.output_dir}</span><span class="s2">/</span><span class="si">{param}</span><span class="s2">/timestepping&#39;&quot;</span>
<span class="n">done</span>
</pre></div>
</div>
<p>After updating the plot, the upper right panel indeed confirms that the two
non-linear neutrino simulations lead to a very similar increase in matter
power, when compared to the simulation using linear neutrinos. Note however
that a significant fraction of the speed-up gained by employing the linear
<span class="math notranslate nohighlight">\(\rightarrow\)</span> non-linear transition precisely arose due to the coarser
time-stepping, which has now been reverted back to the finer time-stepping.</p>
<p>To completely eliminate any effects caused by different time-stepping from the
upper right panel, we further need to run the <em>linear</em> neutrino simulation
using the same time-stepping as the non-linear ones. Feel free to do so.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>As stated previously, running with non-linear neutrinos require continual
realisation of the linear pressure and shear. For the non-linear neutrino
evolution within CO<em>N</em>CEPT to turn out correct, the linear inputs from
CLASS then need to be nicely converged. For this to be the case, CLASS must
be run with much higher precision in the neutrino sector than is used by
default, hence the neutrino precision parameters specified in
<code class="docutils literal notranslate"><span class="pre">class_params</span></code> in
<a class="reference internal" href="#param-nonlinear-massive-neutrinos"><span class="std std-ref">the parameter file</span></a>. Stated
briefly, <code class="docutils literal notranslate"><span class="pre">'l_max_ncdm'</span></code> sets the size of the linear massive neutrino
Boltzmann hierarchy, while <code class="docutils literal notranslate"><span class="pre">'Number</span> <span class="pre">of</span> <span class="pre">momentum</span> <span class="pre">bins'</span></code> specifies the
number of discrete neutrino momenta to employ for mapping the neutrino
distribution function. Setting <code class="docutils literal notranslate"><span class="pre">'Quadrature</span> <span class="pre">strategy'</span></code> to <code class="docutils literal notranslate"><span class="pre">2</span></code> ensures
that momentum integrals over the distribution function are integrated all
the way to infinity. Lastly, setting <code class="docutils literal notranslate"><span class="pre">'ncdm_fluid_approximation'</span></code> to
<code class="docutils literal notranslate"><span class="pre">3</span></code> disables the fluid approximation used by default for
massive neutrinos.</p>
<p>For simulations with higher resolution or lower neutrino masses, still
higher values for <code class="docutils literal notranslate"><span class="pre">'l_max_ncdm'</span></code> and <code class="docutils literal notranslate"><span class="pre">'Number</span> <span class="pre">of</span> <span class="pre">momentum</span> <span class="pre">bins'</span></code> may be
required, which can make the usually quick CLASS computation take up hours.
As CO<em>N</em>CEPT runs CLASS in a distributed manner (even across compute
nodes of a cluster) this is not an issue in practice. Furthermore,
CO<em>N</em>CEPT caches all CLASS results to disk by default, so that such
expensive CLASS computations do not have to be redone repeatedly.</p>
</div>
<p>You may play around with different neutrino masses <code class="docutils literal notranslate"><span class="pre">_mass</span></code> and/or transition
times <code class="docutils literal notranslate"><span class="pre">_nutrans</span></code> ‚Äî with or without <code class="docutils literal notranslate"><span class="pre">static_timestepping</span></code> ‚Äî while
continuing to use
<a class="reference internal" href="#plot-nonlinear-massive-neutrinos"><span class="std std-ref">the plotting script</span></a>, as it can
handle output of multiple masses and transition times at the same time.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="working_remotely.html" class="btn btn-neutral float-left" title="6. Working on remote clusters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="bispectra.html" class="btn btn-neutral float-right" title="8. Bispectra and 2LPT" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>