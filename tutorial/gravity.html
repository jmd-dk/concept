

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4. Mastering gravity &mdash; CONCEPT Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  
    <link rel="canonical" href="https://jmd-dk.github.io/concept/tutorial/gravity.html"/>
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Other kinds of output" href="output_types.html" />
    <link rel="prev" title="3. Working with parameter files" href="parameter_files.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> CO<em>N</em>CEPT
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">1. Effortless installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="first_simulations.html">2. Your first simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameter_files.html">3. Working with parameter files</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4. Mastering gravity</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-pm-method">4.1. The PM method</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-p3m-method">4.2. The P³M method</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_types.html">5. Other kinds of output</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_types.html#d-renders">5.1. 3D renders</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_types.html#id1">5.2. 2D renders</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_types.html#snapshots">5.3. Snapshots</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="working_remotely.html">6. Working on remote clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="beyond_matter_only.html">7. Beyond matter-only simulations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="beyond_matter_only.html#radiation">7.1. Radiation</a></li>
<li class="toctree-l3"><a class="reference internal" href="beyond_matter_only.html#massive-neutrinos">7.2. Massive neutrinos</a></li>
<li class="toctree-l3"><a class="reference internal" href="beyond_matter_only.html#dynamical-dark-energy">7.3. Dynamical dark energy</a></li>
<li class="toctree-l3"><a class="reference internal" href="beyond_matter_only.html#decaying-cold-dark-matter">7.4. Decaying cold dark matter</a></li>
<li class="toctree-l3"><a class="reference internal" href="beyond_matter_only.html#non-linear-massive-neutrinos">7.5. Non-linear massive neutrinos</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="utilities.html">8. Using utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="utilities.html#the-powerspec-and-render-utilities">8.1. The powerspec and render utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="utilities.html#the-class-utility">8.2. The CLASS utility</a></li>
<li class="toctree-l3"><a class="reference internal" href="utilities.html#the-update-utility">8.3. The update utility</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#supported-platforms">Supported platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#standard-installation">Standard installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#optimal-network-performance-on-clusters">Optimal network performance on clusters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#cloning-with-git">Cloning with Git</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#the-installer-script-in-depth">The <code class="docutils literal notranslate"><span class="pre">installer</span></code> script in-depth</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#programs-installed">Programs installed</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#command-line-options">Command-line options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#influential-environment-variables">Influential environment variables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#making-use-of-preinstalled-libraries">Making use of preinstalled libraries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#specifying-dependency-versions">Specifying dependency versions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#choosing-compiler-precedence">Choosing compiler precedence</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#installing-mpich-or-openmpi">Installing MPICH or OpenMPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#parallel-builds">Parallel builds</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#using-the-installer-to-install-specific-libraries-but-not-concept-itself">Using the <code class="docutils literal notranslate"><span class="pre">installer</span></code> to install specific libraries but not CO<em>N</em>CEPT itself</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#dependencies">Dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#python-dependencies">Python dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#other-primary-dependencies">Other primary dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#system-dependencies">System dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#the-paths-and-env-files">The <code class="docutils literal notranslate"><span class="pre">.paths</span></code> and <code class="docutils literal notranslate"><span class="pre">.env</span></code> files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#the-paths-file">The <code class="docutils literal notranslate"><span class="pre">.paths</span></code> file</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#the-env-file">The <code class="docutils literal notranslate"><span class="pre">.env</span></code> file</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#path-like-environment-variables"><code class="docutils literal notranslate"><span class="pre">PATH</span></code>-like environment variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#eliminating-interference-from-foreign-python-installations">Eliminating interference from foreign Python installations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#the-mpi-executor">The <code class="docutils literal notranslate"><span class="pre">mpi_executor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../installation.html#the-make-jobs-environment-variable">The <code class="docutils literal notranslate"><span class="pre">make_jobs</span></code> environment variable</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../command_line_options.html">Command-line options</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../command_line_options.html#basics">Basics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#help-h-help">Help: <code class="docutils literal notranslate"><span class="pre">-h</span></code>, <code class="docutils literal notranslate"><span class="pre">--help</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#parameter-file-p-params">Parameter file: <code class="docutils literal notranslate"><span class="pre">-p</span></code>, <code class="docutils literal notranslate"><span class="pre">--params</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#command-line-parameters-c-command-line-param">Command-line parameters: <code class="docutils literal notranslate"><span class="pre">-c</span></code>, <code class="docutils literal notranslate"><span class="pre">--command-line-param</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#number-of-processes-n-nprocs">Number of processes: <code class="docutils literal notranslate"><span class="pre">-n</span></code>, <code class="docutils literal notranslate"><span class="pre">--nprocs</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../command_line_options.html#specifying-multiple-nodes">Specifying multiple nodes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#utility-u-utility">Utility: <code class="docutils literal notranslate"><span class="pre">-u</span></code>, <code class="docutils literal notranslate"><span class="pre">--utility</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#version-v-version">Version: <code class="docutils literal notranslate"><span class="pre">-v</span></code>, <code class="docutils literal notranslate"><span class="pre">--version</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../command_line_options.html#remote-job-submission">Remote job submission</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#queue-q-queue">Queue: <code class="docutils literal notranslate"><span class="pre">-q</span></code>, <code class="docutils literal notranslate"><span class="pre">--queue</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#wall-time-w-wall-time">Wall time: <code class="docutils literal notranslate"><span class="pre">-w</span></code>, <code class="docutils literal notranslate"><span class="pre">--wall-time</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#memory-memory">Memory: <code class="docutils literal notranslate"><span class="pre">--memory</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#job-directive-j-job-directive">Job directive: <code class="docutils literal notranslate"><span class="pre">-j</span></code>, <code class="docutils literal notranslate"><span class="pre">--job-directive</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#no-watching-no-watching">No watching: <code class="docutils literal notranslate"><span class="pre">--no-watching</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../command_line_options.html#other-modes-of-building-running">Other modes of building/running</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#local-local">Local: <code class="docutils literal notranslate"><span class="pre">--local</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#pure-python-pure-python">Pure Python: <code class="docutils literal notranslate"><span class="pre">--pure-python</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#no-recompilation-no-recompilation">No recompilation: <code class="docutils literal notranslate"><span class="pre">--no-recompilation</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#no-optimization-no-optimization">No optimization: <code class="docutils literal notranslate"><span class="pre">--no-optimization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#unsafe-building-unsafe-building">Unsafe building: <code class="docutils literal notranslate"><span class="pre">--unsafe-building</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../command_line_options.html#specials">Specials</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#test-t-test">Test: <code class="docutils literal notranslate"><span class="pre">-t</span></code>, <code class="docutils literal notranslate"><span class="pre">--test</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#main-entry-point-m-main">Main entry point: <code class="docutils literal notranslate"><span class="pre">-m</span></code>, <code class="docutils literal notranslate"><span class="pre">--main</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../command_line_options.html#interactive-i-interactive">Interactive: <code class="docutils literal notranslate"><span class="pre">-i</span></code>, <code class="docutils literal notranslate"><span class="pre">--interactive</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../parameters/parameters.html">Parameters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../parameters/input_output.html">Input/output</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#initial-conditions"><code class="docutils literal notranslate"><span class="pre">initial_conditions</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../parameters/input_output.html#snapshot-type"><code class="docutils literal notranslate"><span class="pre">snapshot_type</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/numerical_parameters.html">Numerical parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/numerical_parameters.html#boxsize"><code class="docutils literal notranslate"><span class="pre">boxsize</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/cosmology.html">Cosmology</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/cosmology.html#class-params"><code class="docutils literal notranslate"><span class="pre">class_params</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/physics.html">Physics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/physics.html#select-forces"><code class="docutils literal notranslate"><span class="pre">select_forces</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/simulation_options.html">Simulation options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/simulation_options.html#t-base-background-factor"><code class="docutils literal notranslate"><span class="pre">Δt_base_background_factor</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/graphics.html">Graphics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/graphics.html#terminal-width"><code class="docutils literal notranslate"><span class="pre">terminal_width</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/system_of_units.html">System of units</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/system_of_units.html#unit-length"><code class="docutils literal notranslate"><span class="pre">unit_length</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../parameters/debugging_options.html">Debugging options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../parameters/debugging_options.html#print-load-imbalance"><code class="docutils literal notranslate"><span class="pre">print_load_imbalance</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../utilities/utilities.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../utilities/class.html">The CLASS utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/convert.html">The convert utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/gadget.html">The gadget utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/info.html">The info utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/play.html">The play utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/powerspec.html">The powerspec utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/render2D.html">The render2D utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/render3D.html">The render3D utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/update.html">The update utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities/watch.html">The watch utility</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../under_the_hood.html">Looking under the hood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#installation-failed">Installation failed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#compilation-failed">Compilation failed</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#insufficient-memory">Insufficient memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#dangerous-optimizations">Dangerous optimizations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#terminal-color-output-looks-weird">Terminal color output looks weird</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#problems-related-to-python-libraries-and-packages">Problems related to Python libraries and packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#error-messages-containing-read-1">Error messages containing ‘Read -1’</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#the-simulation-hangs-when-calling-class">The simulation hangs when calling CLASS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#crashes-or-other-bad-behavior">Crashes or other bad behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#problems-when-running-remotely">Problems when running remotely</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#different-hardware-architecture-on-front-end-and-remote-node">Different hardware architecture on front-end and remote node</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#choosing-an-mpi-executor">Choosing an MPI executor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#it-still-does-not-work">It <em>still</em> does not work!</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#bad-performance-when-using-multiple-processes-nodes">Bad performance when using multiple processes/nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#problems-when-using-multiple-nodes">Problems when using multiple nodes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../publications.html#theses">Theses</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CO<em>N</em>CEPT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorial.html">Tutorial</a> &raquo;</li>
        
      <li><span class="section-number">4. </span>Mastering gravity</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/jmd-dk/concept/" class="fa fa-github"> Code Repository</a>
            
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="output_types.html" class="btn btn-neutral float-right" title="5. Other kinds of output" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="parameter_files.html" class="btn btn-neutral float-left" title="3. Working with parameter files" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mastering-gravity">
<h1><span class="section-number">4. </span>Mastering gravity<a class="headerlink" href="#mastering-gravity" title="Permalink to this headline">¶</a></h1>
<p>The fact that gravity is extremely important for the particle evolution has
already been demonstrated. We would like our simulation to be able to compute
gravity in a manner that is both accurate and efficient, but in practice one
has to sacrifice one for the other. In CO<em>N</em>CEPT, the details of the
gravitational computation is controlled by a large set of parameters, enabling
us to tune this tradeoff between accuracy and efficiency to our heart’s
desire.</p>
<p>In order to learn how to control gravity within CO<em>N</em>CEPT we shall run
some sample simulations. The parameter specifications below are very similar
to the ones encountered in the previous section. Save these in
<code class="docutils literal notranslate"><span class="pre">params/tutorial</span></code>.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Non-parameter helper variable used to control the size of the simulation</span>
<span class="n">_size</span> <span class="o">=</span> <span class="mi">64</span>

<span class="c1"># Input/output</span>
<span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;matter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;N&#39;</span>      <span class="p">:</span> <span class="n">_size</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">output_dirs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">basename</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
<span class="p">}</span>
<span class="n">output_bases</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;powerspec_</span><span class="si">{</span><span class="n">_sim</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">output_times</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;powerspec&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Numerical parameters</span>
<span class="n">boxsize</span> <span class="o">=</span> <span class="mi">256</span><span class="o">*</span><span class="n">Mpc</span>

<span class="c1"># Cosmology</span>
<span class="n">H0</span>      <span class="o">=</span> <span class="mi">67</span><span class="o">*</span><span class="n">km</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">Mpc</span><span class="p">)</span>
<span class="n">Ωb</span>      <span class="o">=</span> <span class="mf">0.049</span>
<span class="n">Ωcdm</span>    <span class="o">=</span> <span class="mf">0.27</span>
<span class="n">a_begin</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="c1"># Physics</span>
<span class="n">select_forces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="s1">&#39;gravity&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now run a simulation using these parameters, by executing</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept -p params/tutorial -c <span class="s2">&quot;_sim = &#39;A&#39;&quot;</span>
</pre></div>
</div>
<p>and optionally specifying whatever number of CPU cores you’d like with the
<code class="docutils literal notranslate"><span class="pre">-n</span></code> option.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that a choice of e.g. <code class="docutils literal notranslate"><span class="pre">-n</span> <span class="pre">3</span></code> is illegal as
<span class="math notranslate nohighlight">\(N=64^3\)</span> is not divisible by <span class="math notranslate nohighlight">\(3\)</span>. More of such
restrictions exist. If an illegal number of processes is chosen, this will
be detected and a helpful error message is shown.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">output_bases</span></code> parameter has been used to specify the base of filenames
for power spectrum output. This is set up to depend on a helper variable
<code class="docutils literal notranslate"><span class="pre">_sim</span></code>, which we supply from the command-line. This way we can run multiple
simulations without having their outputs overwrite each other, by specifying a
different value of <code class="docutils literal notranslate"><span class="pre">_sim</span></code> for each run.</p>
<p>The result of the simulation will be a data file
<code class="docutils literal notranslate"><span class="pre">output/tutorial/powerspec_A_a=1.00</span></code> of the matter power spectrum at
<span class="math notranslate nohighlight">\(a=1\)</span>, along with the corresponding plot
<code class="docutils literal notranslate"><span class="pre">output/tutorial/powerspec_A_a=1.00.png</span></code>.</p>
<div class="section" id="the-pm-method">
<h2><span class="section-number">4.1. </span>The PM method<a class="headerlink" href="#the-pm-method" title="Permalink to this headline">¶</a></h2>
<p>Without further specification, CO<em>N</em>CEPT solves gravity using the
particle-mesh (PM) method. We may also specify this choice explicitly using</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_forces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="s1">&#39;pm&#39;</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The PM method works by solving for the gravitational potential on a grid. By
default, the resolution of this grid is set to match the number of particles.
Again, we may specify this choice explicitly using</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_forces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="n">_size</span><span class="p">)},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The potential grid is then a cubic
<code class="docutils literal notranslate"><span class="pre">_size</span></code><span class="math notranslate nohighlight">\(\times\)</span><code class="docutils literal notranslate"><span class="pre">_size</span></code><span class="math notranslate nohighlight">\(\times\)</span><code class="docutils literal notranslate"><span class="pre">_size</span></code> mesh, dividing
the box into smaller cells.</p>
<p>To test whether this really amounts to the default gravitational set-up,
update <code class="docutils literal notranslate"><span class="pre">select_forces</span></code> in <code class="docutils literal notranslate"><span class="pre">params/tutorial</span></code> according to the above and run
a new simulation, this time using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept -p params/tutorial -c <span class="s2">&quot;_sim = &#39;B&#39;&quot;</span>
</pre></div>
</div>
<p>Visually comparing <code class="docutils literal notranslate"><span class="pre">powerspec_A_a=1.00.png</span></code> to <code class="docutils literal notranslate"><span class="pre">powerspec_B_a=1.00.png</span></code>,
we see that the two simulations were indeed exactly the same.</p>
<p>The potential grid introduces a length scale below which gravity cannot be
resolved, namely the width of a mesh cell, here <code class="docutils literal notranslate"><span class="pre">boxsize/_size</span></code>. We may
expect to achieve a more accurate result by lowering this length scale, e.g.
by doubling the size (resolution) of the potential grid (in each direction):</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_forces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">_size</span><span class="p">)},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Try this out, using <code class="docutils literal notranslate"><span class="pre">-c</span> <span class="pre">&quot;_sim</span> <span class="pre">=</span> <span class="pre">'C'&quot;</span></code>.</p>
<p>Comparing the plots of simulation B and C, it’s clear that the choice of grid
size affects the result. What isn’t clear is which result to trust.</p>
</div>
<div class="section" id="the-p3m-method">
<h2><span class="section-number">4.2. </span>The P³M method<a class="headerlink" href="#the-p3m-method" title="Permalink to this headline">¶</a></h2>
<p>A different gravitational method is the particle-particle-particle-mesh (P³M)
method. This method also makes use of a potential grid, but here the grid is
used only to get the gravitational force between particles separated by a
distance much greater than the potential cell size, minimizing discretization
errors. The remaning — so-called short-range — component of gravity
between nearby particles is then computed separately, by directly pairing up
particles and computing the force between them (no potential grid required).</p>
<p>To switch out PM for P³M, simply replace <code class="docutils literal notranslate"><span class="pre">'pm'</span></code> in the <code class="docutils literal notranslate"><span class="pre">select_forces</span></code>
parameter with <code class="docutils literal notranslate"><span class="pre">'p3m'</span></code>. Let’s run a simulation D using</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_forces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;p3m&#39;</span><span class="p">,</span> <span class="n">_size</span><span class="p">)},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You will notice that this time, the simulation takes several times longer to
complete. Studying the text printed to the screen, we see that the work within
each time step is split into a short-range and a long-range part. From the
computation times stated in parentheses to the right, it’s clear that the
short-range part is by far the most time-consuming.</p>
<p>Once completed, compare the plot from the P³M simulation D to that of the PM
simulations B and C. You will find that we now have three different results.</p>
<p>As before, let’s now double the grid size, and perform a final simulation, E:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_forces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;p3m&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">_size</span><span class="p">)},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You will find that this time, the P³M simulation isn’t nearly as slow, as
the smaller potential cell size leads to less work to be done for the
short-range part.</p>
<p>Comparing the results of simulation D and E, we see that these are very
similar, implying that the size of the potential grid is largely irrelevant
regarding the accuracy of the P³M method. To better compare the results of
simulation A–E, you should plot the different power spectra together in a
single plot, using the information in the data files. You may do this using
your favourite plotting program, or — for your convenience — using the
script below:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">this_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/powerspec*&#39;</span><span class="p">)):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;powerspec_(.+)_a=[\d.]+$&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">P_sim</span><span class="p">,</span> <span class="n">P_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">linetype</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="k">if</span> <span class="n">sim</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">}</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P_sim</span><span class="p">,</span> <span class="n">linetype</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;simulation </span><span class="si">{</span><span class="n">sim</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P_lin</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k$ $[\mathrm</span><span class="si">{Mpc}</span><span class="s1">^{-1}]$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;power $[\mathrm</span><span class="si">{Mpc}</span><span class="s1">^3]$&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">this_dir</span><span class="si">}</span><span class="s1">/plot.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To use the above script, save the code to a file in the <code class="docutils literal notranslate"><span class="pre">output/tutorial</span></code>
directory, say <code class="docutils literal notranslate"><span class="pre">output/tutorial/plot.py</span></code>, then do</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./concept -m output/tutorial/plot.py
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-m</span></code> command-line option redirects <code class="docutils literal notranslate"><span class="pre">concept</span></code> to run the specified
Python script, rather than launching a CO<em>N</em>CEPT simulation. In this
case, this is almost equivalent to just running the script using Python
directly, but using <code class="docutils literal notranslate"><span class="pre">./concept</span> <span class="pre">-m</span></code> we are guarenteed that the environment
is set up correctly, according to the CO<em>N</em>CEPT installation.</p>
</div>
<p>The script will produce the output <code class="docutils literal notranslate"><span class="pre">output/tutorial/plot.png</span></code>.</p>
<p>Studying the collective plot containing all our simulation power spectra, it
is indeed clear that the P³M simulations agree far better with each other than
do the PM simulations. We should thus set our trust in the P³M power spectra,
not the PM ones. Generally, though much slower, the P³M method is then the
preferred gravitational method to use in CO<em>N</em>CEPT. As we saw, increasing
the size of the potential grid used can dramatically cut down the computation
time. In fact, it may well be worth it to increase it even further than what
was done here, though at the cost of increased memory consumption.</p>
<p>It is remarkable that not only is the PM force not invariant under a change in
grid size, but the smaller of the two grids actually produced the better
result, as evident from the collective plot (taking the P³M power spectra to
be essentially exact).</p>
<p>Though inadequate for precise particle simulations, the PM method is still a
valuable tool, as sometimes the benefits of rapid simulations outweigh the
drawbacks from loss of precision. Also, as we shall
<a class="reference internal" href="beyond_matter_only.html"><span class="doc">delve into later</span></a>, PM gravity is as accurate as
can be for fluid (i.e. non-particle) components, used to model species
different from matter. Finally — though sticking to default values are
generally recommended — you should be aware that the details about the PM
and P³M methods can be further specified using
<a class="reference internal" href="../parameters/numerical_parameters.html"><span class="doc">various parameters</span></a>, affecting the
performance and accuracy.</p>
<h3>The PP method</h3><p>Finally, let it be known that CO<em>N</em>CEPT also supports the bare
particle-particle (PP) method, which simply performs the naïve pairwise
force computation between all particles, effecively computing “short”-range
forces as in the P³M method, but now across the entire simulation box.</p>
<p>As expected, the PP method may be specified using</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_forces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;matter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;gravity&#39;</span><span class="p">:</span> <span class="s1">&#39;pp&#39;</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you actually try this out, reduce <code class="docutils literal notranslate"><span class="pre">_size</span></code> to <em>at most</em> 32, as running a
PP simulation with <span class="math notranslate nohighlight">\(64^3\)</span> particles literately takes days. Though
slightly more accurate than the P³M method, the PP method should never be used
for running simulations and is only really included in CO<em>N</em>CEPT as it is
used internally when running tests. Running (well, starting) a small PP
simulation at least once will help any user of <em>N</em>-body codes appreciate the
enourmous performance gains achieved by the more sophisticated methods.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="output_types.html" class="btn btn-neutral float-right" title="5. Other kinds of output" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="parameter_files.html" class="btn btn-neutral float-left" title="3. Working with parameter files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>