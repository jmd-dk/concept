# GitHub workflow for testing the code base by running the test suite
name: test_suite

on:
    pull_request:
        branches:
          - master
        paths:
          - 'Makefile'
          - 'concept'
          - 'src/**'
          - 'test/**'
          - 'util/**'

jobs:
    # This job runs first
    test_basic:
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ‹ Clean dangling Docker containers
            uses: ./.github/actions/docker-clean
          - name: ğŸ“ Set Docker username
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            run: |
                [ -n "${docker_username}" ] || docker_username=jmddk
                echo "docker_username=${docker_username}" >> "${GITHUB_ENV}"
          - name: ğŸ‹ Pull Docker image
            run: docker pull ${docker_username}/concept:latest
          - name: ğŸ¤– Run test
            run: |
                sleep 1
                docker run \
                    -e GITHUB_JOB \
                    -e make_jobs="-j 1" \
                    -v "${GITHUB_WORKSPACE}":/github \
                    --name "${GITHUB_REPOSITORY//\//_}__${GITHUB_WORKFLOW}__${GITHUB_JOB}__$(date +%s)" \
                    --rm \
                    ${docker_username}/concept:latest \
                    bash -O extglob -c ': \
                        && source ~/.bashrc \
                        && rm -rf "${concept_dir}/"!(dep) \
                        && cp -r /github/!(dep) "${concept_dir}/" \
                        && concept -t ${GITHUB_JOB/test_} \
                        && rm -rf /github/build \
                        && mkdir /github/build \
                        && cp "${build_dir}/"*.so /github/build/ \
                        && chmod a+rw /github/build/ \
                    '
          - name: ğŸ“¤ Upload build
            uses: actions/upload-artifact@v2
            with:
                name: build
                path: build
    # All jobs below uses the compiled code from the test_basic job
    test_friedmann:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_realize:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_powerspec:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_gadget:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_drift_nohubble:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_drift:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_kick_pp_without_ewald:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_kick_pp_with_ewald:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_nprocs_pp:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_pure_python_pp:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_concept_vs_gadget_pp:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_nprocs_pm:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_pure_python_pm:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_concept_vs_class_pm:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_nprocs_p3m:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_pure_python_p3m:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_concept_vs_gadget_p3m:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_multicomponent:
        needs: test_basic
        runs-on: [self-hosted, linux, heavy]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_multigrid:
        needs: test_basic
        runs-on: [self-hosted, linux, heavy]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_fluid_drift_rigid_nohubble:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_fluid_drift_rigid:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_fluid_gravity_nohubble:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_fluid_gravity:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_fluid_vacuum:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_fluid_vs_particles:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_fluid_pressure:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_neutrino:
        needs: test_basic
        runs-on: [self-hosted, linux, heavy]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_optimizations:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test
    test_render:
        needs: test_basic
        runs-on: [self-hosted, linux, light]
        steps:
          - name: ğŸ›ï¸ Checkout
            uses: actions/checkout@v2
          - name: ğŸ¤– Run test
            env:
                docker_username: ${{ secrets.DOCKER_USERNAME }}
            uses: ./.github/actions/test

